<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="stylesheet" href="patch_admin_localidades.css">
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CCB - Compra Coletiva</title>

<!-- ======= ESTILOS ======= -->
<style>
  :root{
    --pri:#0056b3; --pri-700:#004080; --bg:#f0f4f8; --ok:#28a745; --warn:#f0ad4e; --err:#b30000;
    --text:#111; --muted:#6b7280; --br:10px; --shadow:0 6px 20px rgba(10,10,20,.06);
  }
  *{ box-sizing:border-box; }
  html,body{
  height:100%;
  width:100%;
  margin:0;
  overflow-x:hidden; /* impede que o conte√∫do saia pela direita */
}

  body{ font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); margin:0; }
  header{ background:var(--pri); color:#fff; padding:14px 16px; position:sticky; top:0; z-index:20; box-shadow:0 2px 12px rgba(0,0,0,.12);
    display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  header .title{ font-size:20px; font-weight:700; flex:1; }
  header .clock{ font-size:12px; opacity:.9; }
  header .tag{ background:rgba(255,255,255,.15); padding:4px 8px; border-radius:999px; font-size:12px; }
  main{ margin:18px auto; max-width:1120px; padding:0 14px; }
  .card{ background:#fff; border-radius:var(--br); box-shadow:var(--shadow); padding:18px; margin:0 auto 18px; width:100%; }
  h2{ color:var(--pri); margin:0 0 12px 0; font-size:20px; }
  h3{ color:#1f2937; margin:16px 0 8px 0; font-size:18px; }
  input, select, button, textarea{ width:100%; padding:10px; margin:6px 0; font-size:16px; border-radius:6px; border:1px solid #d1d5db; background:#fff; }
  input[type=number]{ -moz-appearance:textfield; }
  textarea{ min-height:90px; resize:vertical; }
  button{ background:var(--pri); color:#fff; border:none; cursor:pointer; font-weight:700; transition:.15s transform ease,.15s background ease; }
  button:hover{ background:var(--pri-700); transform:translateY(-1px); }
  .btn-muted{ background:#e5e7eb; color:#111; }
  .btn-muted:hover{ background:#d1d5db; }
  .btn-danger{ background:var(--err); }
  .btn-ok{ background:var(--ok); }
  .btn-warn{ background:var(--warn); color:#111; }
  .menu{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .menu button{ flex:1; min-width:160px; }
  .small{ font-size:13px; padding:6px 10px; }
  .hidden{ display:none !important; } .center{ text-align:center; } .right{ text-align:right; } .muted{ color:var(--muted); }
  .table-wrap{
  width:100%;
  overflow-x:auto;
  overflow-y:hidden;
  border:1px solid #e5e7eb;
  border-radius:8px;
  max-width:100vw; /* garante que nunca passe da tela */
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:100%;
}

  th,td{ border-bottom:1px solid #eee; padding:10px; text-align:left; }
  th{ background:var(--pri); color:#fff; position:sticky; top:0; }
  tr:hover td{ background:#fafafa; }
  .delivered{ background:#e8ffe8; }
  .status-aberto{ color:#d9534f; font-weight:700; }
  .status-entregue{ color:#28a745; font-weight:700; }
  .actions button{ margin-right:6px; margin-bottom:6px; }
  #listaProdutos{ max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; display:none; background:#fff; margin-top:4px; }
  #listaProdutos > div{ padding:10px; cursor:pointer; border-bottom:1px solid #f3f4f6; }
  #listaProdutos > div:hover{ background:#f9fafb; }
  #modalOverlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.55);
  padding: 20px;
}

#modalOverlay.active {
  display: flex;
}

#modalBox {
  background: #fff;
  width: 95%;
  max-width: 900px;
  max-height: 90vh; /* ‚Üê limita a altura */
  overflow-y: auto; /* ‚Üê ativa a rolagem */
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
  animation: pop 0.18s ease-out;
  position: relative; /* ‚Üê pra posicionar o bot√£o X */
}

  @keyframes pop{ from{ transform:scale(.98); opacity:.4; } to{ transform:scale(1); opacity:1; } }
  #modalBox h3{ color:var(--pri); text-align:center; margin:0 0 10px 0; }
  .chipbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 10px; }
  .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; background:#fff; font-size:13px; }
  .chip input[type=checkbox]{ width:auto; margin:0; }
  .print-header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px; }
  .print-meta{ font-size:12px; color:#444; }
  .signature-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:16px; }
  .signature-box{ border-top:1px solid #000; padding-top:6px; text-align:center; font-size:12px; }
  .check-col{ width:120px; text-align:center; }
  footer{ text-align:center; color:#6b7280; font-size:12px; padding:14px 0 24px; }
  @media (max-width:640px){ header .title{ width:100%; } .menu{ flex-direction:column; } table{ min-width:640px; } .signature-grid{ grid-template-columns:1fr; } }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e3a8a; }
  .warn-note{ background:#fff7ed; border:1px dashed #f59e0b; padding:10px; border-radius:8px; color:#7c2d12; }
</style>
</head>
<body>

<header>
  <div class="title">CCB - Compra Coletiva</div>
  <div class="tag" id="cycleTag">Carregando ciclo‚Ä¶</div>
  <div class="clock" id="nowClock">--/--/---- --:--</div>
</header>

<main>

  <!-- LOGIN -->
  <section id="loginScreen" class="card">
    <h2>Login</h2>
    <input type="text" id="loginUser" placeholder="Usu√°rio" autocomplete="username"/>
    <input type="password" id="loginPass" placeholder="Senha" autocomplete="current-password"/>
    <div class="menu">
      <button id="btnLogin">Entrar</button>
      <!-- Registro p√∫blico removido: cadastro √© por libera√ß√£o do admin -->
      <button class="btn-muted" id="btnWhatsapp">
        WhatsApp ‚Äì Compra Coletiva
      </button>
    </div>
    <p class="center muted" style="margin-top:6px;">
      Para se cadastrar, excluir cadastro, ou adicionar algum produto no mix,
      <b>entre em contato com a Compra Coletiva clicando acima</b>.
    </p>
    <p id="loginError" class="center" style="color:var(--err); min-height:18px;"></p>
  </section>

  <!-- 1¬∫ ACESSO (PROVIS√ìRIO) / COMPLETAR CADASTRO -->
  <section id="primeiroAcessoScreen" class="card hidden">
    <h2>Completar Cadastro (Acesso Provis√≥rio)</h2>
    <div class="warn-note">Foi liberado um login provis√≥rio. Crie seu usu√°rio definitivo e senha, e complete seus dados.</div>
    <div class="menu">
      <input id="paNome" placeholder="Nome completo"/>
      <select id="paGenero">
        <option value="auto">Detectar pelo nome</option>
        <option value="M">Masculino</option>
        <option value="F">Feminino</option>
      </select>
    </div>
    <div class="menu">
      <div style="flex:1;">
        <label class="small muted">CEP</label>
        <input id="paCep" placeholder="Somente n√∫meros"/>
        <button id="btnBuscaCepPA" class="small">Buscar CEP</button>
        <div class="small muted">Ou marque ‚ÄúOutra localidade‚Äù para digitar manualmente.</div>
      </div>
      <div style="flex:1; display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="paOutraLocalidade" style="width:auto;"/>
        <label for="paOutraLocalidade">Outra localidade</label>
      </div>
    </div>
    <div class="menu">
      <input id="paLogradouro" placeholder="Logradouro" disabled/>
      <input id="paBairro" placeholder="Bairro" disabled/>
    </div>
    <div class="menu">
      <input id="paCidade" placeholder="Cidade" disabled/>
      <input id="paUf" placeholder="UF" disabled/>
    </div>
    <div class="menu">
      <input id="paUser" placeholder="Novo usu√°rio"/>
      <input id="paPass" placeholder="Nova senha" type="password"/>
    </div>
    <div class="menu">
      <button id="btnConcluirPA" class="btn-ok">Concluir Cadastro</button>
      <button id="btnVoltarPA" class="btn-muted">Sair</button>
    </div>
    <p id="paMsg" class="center" style="min-height:18px;"></p>
  </section>

  <!-- PEDIDO (HOME) -->
  <section id="pedidoScreen" class="card hidden">
    <h2>Fazer Pedido</h2>

    <input type="text" id="buscaProduto" placeholder="Buscar produto (digite o in√≠cio do nome)..." autocomplete="off"/>
    <div id="listaProdutos"></div>

    <div class="menu">
      <input type="number" id="quantidade" placeholder="Quantidade" min="1"/>
      <input type="text" id="obs" placeholder="Observa√ß√µes"/>
    </div>

    <div class="menu">
      <button id="btnSalvarPedido">Enviar Pedido</button>
      <button class="btn-muted" id="btnMeusPedidos">Meus Pedidos</button>
    </div>

    <div class="menu" style="margin-top:8px;">
      <button id="adminRelatorioBtn" class="hidden">Relat√≥rios (Admin)</button>
      <button id="adminProdutosBtn" class="hidden">Produtos (Admin)</button>
      <button id="adminUsuariosBtn" class="hidden">Usu√°rios (Admin)</button>
      <button id="adminHistoricoBtn" class="hidden">Hist√≥rico (Admin)</button>
    </div>

    <div class="menu" style="margin-top:6px;">
<button id="btnMeuEstoque">üì¶ Meu Estoque</button>

      <button class="btn-danger" id="btnLogout">Sair</button>
    </div>

    <p id="pedidoMsg" class="center" style="color:var(--ok); min-height:18px;"></p>
    <p id="cycleInfo" class="center muted" style="margin-top:6px;"></p>
  </section>

  <!-- RELAT√ìRIO DO USU√ÅRIO -->
  <section id="relatorioUsuario" class="card hidden">
    <div class="print-header">
      <h2>Meus Pedidos</h2>
      <div class="chipbar right">
        <input id="ruIntervalo" placeholder="Linhas: 1-10,12,15-18" style="max-width:260px;"/>
        <button id="btnPreviewRelUsuario">üëÅÔ∏è Visualizar</button>
        <button id="btnImprimirRelUsuario">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
    <div class="chipbar">
      <label class="chip">Status:
        <select id="filtroUsuario" style="border:none;">
          <option value="todos">Todos</option>
          <option value="aberto">Em aberto</option>
          <option value="entregue">Entregues</option>
        </select>
      </label>
      <span class="chip">
        <input type="checkbox" id="toggleOcultarEntreguesUsuario2"/>
        <label for="toggleOcultarEntreguesUsuario2">Ocultar entregues</label>
      </span>
    </div>
    <div class="table-wrap">
      <table id="tabelaPedidosUsuario">
        <thead>
          <tr><th>#</th><th>Produto</th><th>Qtd</th><th>Obs</th><th>Status</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="center" style="margin-top:10px;">
      <button class="btn-muted" id="btnVoltarUsuario">Voltar</button>
    </div>
  </section>

  <!-- RELAT√ìRIO ADMIN -->
  <section id="relatorioAdmin" class="card hidden">
    <div class="print-header">
      <h2>Relat√≥rios (Administrador)</h2>
      <div class="chipbar right">
        <input id="raIntervalo" placeholder="Linhas: 1-50,60-80" style="max-width:260px;"/>
        <button id="btnPreviewRelGeral">üëÅÔ∏è Visualizar</button>
        <button id="btnImprimirRelGeral">üñ®Ô∏è Imprimir Geral</button>
        <button id="btnImprimirRelLocalidade">üñ®Ô∏è Por Localidade</button>
        <button id="btnImprimirResumoItens">üñ®Ô∏è Resumo Itens</button>
<button id="btnPreviewResumoItens">üëÅÔ∏è Visualizar Resumo Itens</button>

        <button id="btnExportFechamento" class="btn-ok">‚¨áÔ∏è Exportar Fechamento (Excel)</button>
<button id="btnRelatorioCiclos" class="btn-warn">üìÖ Relat√≥rios de Ciclos Fechados</button>
<button id="btnRelatorioStatus" class="btn-warn">üì¶ Relat√≥rios por Status</button>
<button id="btnControleEstoque" class="btn-ok">üßæ Controle de Estoques (Admin)</button>
<button id="btnRelatorioMovimentacoes" class="btn-warn">üìä Relat√≥rio de Movimenta√ß√µes (por Ciclo)</button>
<button id="btnExportarExcel" class="btn-ok">‚¨áÔ∏è Exportar Estoques / Movimenta√ß√µes (Excel)</button>
<div class="menu" style="margin-top:20px;">
  <h3>üïì Ciclo Atual</h3>
  <div id="infoCiclo" style="margin-bottom:10px; font-size:0.9rem; color:#333;"></div>
  <button id="btnEncerrarCiclo" class="btn-warn">‚èπÔ∏è Encerrar Ciclo Agora</button>
</div>






      </div>
    </div>

    <div class="chipbar">
      <label class="chip">Status:
        <select id="filtroAdmin" style="border:none;">
          <option value="todos">Todos</option>
          <option value="aberto">Em aberto</option>
          <option value="entregue">Entregues</option>
        </select>
      </label>
      <span class="chip">
        <input type="checkbox" id="toggleOcultarEntreguesAdmin"/>
        <label for="toggleOcultarEntreguesAdmin">Ocultar entregues</label>
      </span>
      <span class="chip"><span class="pill" id="resumoAbertos">Abertos: 0</span></span>
      <span class="chip"><span class="pill" id="resumoEntregues">Entregues: 0</span></span>
      <span class="chip"><span class="pill" id="resumoTotal">Total: 0</span></span>
    </div>

    <h3>Pedidos</h3>
    <div class="table-wrap">
      <table id="tabelaPedidosAdmin">
        <thead>
          <tr>
            <th>#</th><th>Usu√°rio</th><th>Localidade</th><th>Produto</th><th>Qtd</th><th>Obs</th><th>Status</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:16px;">Usu√°rios Cadastrados</h3>
    <div style="text-align:right; margin-bottom:10px;">
      <button id="btnToggleUsuarios" class="btn btn-secondary">üë§ Ocultar usu√°rios cadastrados</button>
    </div>
    <div class="table-wrap">
      <table id="tabelaUsuariosAdmin">
        <thead>
          <tr><th>Nome</th><th>Usu√°rio</th><th>Localidade</th><th>Minist√©rio</th><th>Provis√≥rio?</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:16px;">Produtos</h3>
    
    <div class="table-wrap">
      <table id="tabelaProdutosAdmin">
        <thead><tr><th>Produto</th><th>Unidade</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="margin-top:12px;" class="menu">
      <button id="btnAbrirCadastroUsuarioAdmin">Adicionar Usu√°rio (Admin)</button>
      <button id="btnAbrirCadastroProduto">Adicionar Produto (Admin)</button>
      <button class="btn-muted" id="btnVoltarAdmin">Voltar</button>
    </div>
  </section>

  <!-- ADMIN: USU√ÅRIOS -->
  <section id="adminUsuarios" class="card hidden">
    <h2>Adicionar Usu√°rio (Admin)</h2>
    <div class="warn-note">Dica: para liberar cadastro use ‚ÄúProvis√≥rio: SIM‚Äù ‚Äî o irm√£o/irm√£ entra com esse login e trocar√° os dados no primeiro acesso.</div>
    <div class="menu">
      <input id="adminNovoNome" placeholder="Nome completo"/>
      <input id="adminNovoUser" placeholder="Usu√°rio provis√≥rio (ou definitivo)"/>
    </div>
    <div class="menu">
      <input id="adminNovoPass" placeholder="Senha provis√≥ria/definitiva" type="password"/>
      <input id="adminNovoLocalidade" placeholder="Localidade"/>
    </div>
    <div class="menu">
      <select id="adminNovoMinisterio">
        <option value="">-- Selecionar minist√©rio --</option>
        <option>Anci√£o</option><option>Cooperador de of√≠cio</option><option>Cooperador de jovens</option>
        <option>Auxiliar da escrita</option><option>Outros</option>
      </select>
      <select id="adminProvisorio">
        <option value="true">Provis√≥rio: SIM</option>
        <option value="false">Provis√≥rio: N√ÉO</option>
      </select>
    </div>
    <div class="menu">
      <button id="btnAdminAddUser">Adicionar Usu√°rio</button>
      <button class="btn-muted" id="btnVoltarAdminUsr">Voltar</button>
    </div>

    <div class="table-wrap" style="margin-top:10px;">
      <table id="tabelaAdminUsuariosList">
        <thead><tr><th>Nome</th><th>Usu√°rio</th><th>Localidade</th><th>Minist√©rio</th><th>Provis√≥rio?</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ADMIN: PRODUTOS -->
  <section id="adminProdutos" class="card hidden">
    <h2>Produtos (Admin)</h2>
    <div class="menu">
      <input id="novoProdutoNome" placeholder="Nome do produto"/>
      <input id="novoProdutoUnidade" placeholder="Unidade (ex: pacote, rolo, unidade)"/>
    </div>
    <div class="menu">
      <button id="btnAddProduto">Adicionar Produto</button>
      <button class="btn-muted" id="btnVoltarAdminProd">Voltar</button>
    </div>
    <div class="table-wrap" style="margin-top:10px;">
      <table id="tabelaProdutosAdminList">
        <thead><tr><th>Produto</th><th>Unidade</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- HIST√ìRICO (ADMIN) -->
  <section id="historicoAdmin" class="card hidden">
    <h2>Hist√≥rico do Sistema (Admin)</h2>
    <p class="warn-note">Apenas administradores visualizam. Aqui constam: logins, logouts, cria√ß√£o/edi√ß√£o/exclus√£o de pedidos, altera√ß√µes de senha e demais eventos.</p>

    <div class="chipbar">
      <span class="chip">
        <input type="checkbox" id="toggleOcultarHistorico"/>
        <label for="toggleOcultarHistorico">Ocultar hist√≥rico</label>
      </span>
      <label class="chip">Tipo:
        <select id="filtroHistoricoTipo" style="border:none;">
          <option value="todos">Todos</option>
          <option value="login">Login</option>
          <option value="logout">Logout</option>
          <option value="pedido">Pedidos</option>
          <option value="perfil">Perfil</option>
          <option value="sistema">Sistema</option>
        </select>
      </label>
    </div>

    <div class="kpi" style="display:grid;grid-template-columns: repeat(4,minmax(160px,1fr));gap:10px;margin:10px 0 6px;">
      <div class="item" style="background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px;">
        <div class="label muted">Eventos (30 dias)</div><div class="val" id="kpiEvt30" style="font-weight:800;font-size:18px;">--</div>
      </div>
      <div class="item" style="background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px;">
        <div class="label muted">Logins hoje</div><div class="val" id="kpiLoginHoje" style="font-weight:800;font-size:18px;">--</div>
      </div>
      <div class="item" style="background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px;">
        <div class="label muted">Pedidos criados hoje</div><div class="val" id="kpiPedidosHoje" style="font-weight:800;font-size:18px;">--</div>
      </div>
      <div class="item" style="background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px;">
        <div class="label muted">Altera√ß√µes de senha (30 dias)</div><div class="val" id="kpiPwd30" style="font-weight:800;font-size:18px;">--</div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tabelaHistoricoAdmin">
        <thead>
          <tr><th>Data/Hora</th><th>Usu√°rio</th><th>Tipo</th><th>Descri√ß√£o</th><th>Detalhes</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="menu">
      <button class="btn-muted" id="btnVoltarHistorico">Voltar</button>
    </div>
  </section>

  <!-- MODAL GEN√âRICO -->
  <div id="modalOverlay" class="hidden">
    <div id="modalBox">
  <button id="closeModalX" style="position:absolute; top:8px; right:10px; background:none; border:none; font-size:22px; cursor:pointer;">‚úñ</button>
  <h3 id="modalTitulo"></h3>

      <div id="modalConteudo"></div>
      <div class="center" style="margin-top:12px;">
        <button class="btn-muted" id="btnFecharModal">Fechar</button>
      </div>
    </div>
  </div>

  <!-- TEMPLATES IMPRESS√ÉO -->
  <template id="tpl-impressao-usuario">
    <div>
      <div class="print-header">
        <div>
          <h3 style="margin:0;">Meus Pedidos</h3>
          <div class="print-meta" id="print-meta-usuario">Gerado em --/--/---- --:--</div>
          <div class="print-meta" id="print-solicitante">Solicitante: --</div>
          <div class="print-meta" id="print-localidade">Localidade: --</div>
          <div class="print-meta" id="print-ministerio">Minist√©rio: --</div>
        </div>
        <div class="print-meta"><div id="print-ciclo">Ciclo: --</div></div>
      </div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#0056b3; color:#fff;">
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Qtd</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Obs</th>
            <th class="check-col" style="border:1px solid #ddd;">Visto ‚úì</th>
          </tr>
        </thead>
        <tbody id="print-tbody-usuario"></tbody>
      </table>
      <div class="signature-grid">
        <div class="signature-box">Assinatura do Solicitante</div>
        <div class="signature-box">Conferente / Visto</div>
      </div>
    </div>
  </template>

  <template id="tpl-impressao-geral">
    <div>
      <div class="print-header">
        <div>
          <h3 style="margin:0;">Relat√≥rio Geral de Pedidos</h3>
          <div class="print-meta" id="print-meta-geral">Gerado em --/--/---- --:--</div>
        </div>
        <div class="print-meta"><div id="print-ciclo-geral">Ciclo: --</div></div>
      </div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#0056b3; color:#fff;">
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Usu√°rio</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Localidade</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Qtd</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Obs</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Status</th>
            <th class="check-col" style="border:1px solid #ddd;">Visto ‚úì</th>
          </tr>
        </thead>
        <tbody id="print-tbody-geral"></tbody>
      </table>
      <div class="signature-grid">
        <div class="signature-box">Respons√°vel / Assinatura</div>
        <div class="signature-box">Conferente / Visto</div>
      </div>
    </div>
  </template>

</main>

<footer>
  <div>¬© <span id="yearFooter"></span> CCB - Compra Coletiva. Todos os direitos reservados.</div>
</footer>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<!-- SheetJS para Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===============================
   APP ‚Äì Firebase + L√≥gica
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyDwpb9gdYL8qzJfaref3bi0miXiJhiH1Ds",
  authDomain: "compra-coletiva-ccb-web.firebaseapp.com",
  databaseURL: "https://compra-coletiva-ccb-web-default-rtdb.firebaseio.com",
  projectId: "compra-coletiva-ccb-web",
  storageBucket: "compra-coletiva-ccb-web.appspot.com",

  messagingSenderId: "20688611131",
  appId: "1:20688611131:web:c0fbaa91045c538e23f91e"
};
try{ if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); }catch(e){}
const db = firebase.database();

/* ======= VARS ======= */
const ADMIN_LOGIN = "fernando_filho87";
const ADMIN_PASSWORD = "1502";
const WHATSAPP_PHONE = "5531985330656"; // com DDI +55
let currentUser = null;
let produtosCache = [];
let selectedProductKey = null;
let lastScreen = "loginScreen";
let audioCtx = null;

/* ======= UTILS ======= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
function fmtDateTime(ts){ const d=new Date(ts); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yyyy} ${hh}:${mi}`; }
function monthIdFrom(ts){ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function normalize(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
function showToast(msg, type='info', t=2000){ // simples
  const div = document.createElement('div');
  div.style.position='fixed'; div.style.left='50%'; div.style.top='18px'; div.style.transform='translateX(-50%)';
  div.style.background= type==='error'?'#b30000':(type==='warn'?'#f0ad4e':'#0056b3'); div.style.color='#fff'; div.style.padding='10px 14px';
  div.style.borderRadius='8px'; div.style.boxShadow='0 8px 20px rgba(0,0,0,.2)'; div.style.zIndex='9999';
  div.innerText = msg; document.body.appendChild(div); setTimeout(()=>div.remove(), t);
}
// ======= Alternar "Outra Localidade" no primeiro acesso =======
function togglePAOutraLocalidade(checked){
  const campos = ['#paLogradouro','#paBairro','#paCidade','#paUf'];
  campos.forEach(sel => {
    const el = document.querySelector(sel);
    if (!el) return;
    el.disabled = !checked;
    if (!checked) el.value = '';
  });
}

function abrirModal(titulo, conteudoHtml){ $('#modalTitulo').innerText=titulo||''; $('#modalConteudo').innerHTML=conteudoHtml||''; $('#modalOverlay').classList.remove('hidden'); $('#modalOverlay').classList.add('active'); }
function fecharModal(){ $('#modalOverlay').classList.remove('active'); $('#modalOverlay').classList.add('hidden'); $('#modalTitulo').innerText=''; $('#modalConteudo').innerHTML=''; }
$('#btnFecharModal').addEventListener('click', fecharModal);
$('#closeModalX').addEventListener('click', fecharModal);


/* ======= √ÅUDIO (WebAudio) ======= */
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }
function playChime(type='login'){ try{
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = (type==='login')? 880 : 523; // mais alto/limpo
  g.gain.value = 0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  // fade-in breve + fade-out mais longo
  const now = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.2, now+0.04);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
  o.stop(now+0.65);
}catch(e){} }

/* ======= Sauda√ß√£o com g√™nero ======= */
function guessGeneroByNome(nome){
  if(!nome) return 'M'; // padr√£o
  const n = normalize(nome).split(' ')[0]; // primeiro nome
  // regras simples:
  if(n.endsWith('a') || n.endsWith('e')) return 'F';
  return 'M';
}
function saudacaoLogin(nome, genero){
  const g = genero==='auto' ? guessGeneroByNome(nome) : genero;
  const termo = (g==='F')? 'irm√£' : 'irm√£o';
  return `A paz de Deus, ${termo} ${nome || ''}...! √â muito importante seu zelo com a irmandade e com a obra de Deus! Fa√ßa bom proveito dos itens que o Senhor Deus est√° disponibilizando para compras.`;
}
function saudacaoSaida(nome, genero){
  const g = genero==='auto' ? guessGeneroByNome(nome) : genero;
  const termo = (g==='F')? 'irm√£' : 'irm√£o';
  return `Deus aben√ßoe, ${termo} ${nome || ''}...! Sa√∫da em casa com a santa paz de Deus!`;
}

/* ======= Mensagem de transi√ß√£o ======= */
function msgTransicao(texto, duracao=10000){ // 10s conforme pedido
  return new Promise(res=>{
    const overlay=document.createElement('div');
    Object.assign(overlay.style,{position:'fixed',inset:'0',background:'linear-gradient(135deg,#0056b3,#004080)',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:'24px',fontWeight:'700',textAlign:'center',zIndex:'9999',opacity:'0',transition:'opacity .4s ease',padding:'20px',whiteSpace:'pre-wrap'});
    overlay.innerText = texto;
    document.body.appendChild(overlay);
    setTimeout(()=>overlay.style.opacity='1',20);
    setTimeout(()=>{
      overlay.style.opacity='0';
      setTimeout(()=>{ overlay.remove(); res(); }, 350);
    }, duracao);
  });
}

/* ======= Navega√ß√£o ======= */
function hideAll(){ ['loginScreen','primeiroAcessoScreen','pedidoScreen','relatorioUsuario','relatorioAdmin','adminProdutos','adminUsuarios','historicoAdmin'].forEach(id=>$('#'+id)?.classList.add('hidden')); }
function go(id){ hideAll(); $('#'+id)?.classList.remove('hidden'); lastScreen=id; }

/* ======= Ciclo ======= */
async function getCycleInfo(){
  try{
    const snap = await db.ref('config/cycleStart').once('value');
    const start = snap.val() || Date.now(); const now=Date.now();
    const daysElapsed = Math.floor((now-start)/(24*60*60*1000));
    const daysRemaining = 30 - daysElapsed; const open = daysElapsed < 30;
    return { start, now, daysElapsed, daysRemaining, open, cycleId: monthIdFrom(start) };
  }catch(e){ return { start: Date.now(), now: Date.now(), daysElapsed:0, daysRemaining:30, open:true, cycleId: monthIdFrom(Date.now()) }; }
}
async function updateCycleInfoUI(){
  const info = await getCycleInfo();
  $('#cycleInfo').textContent = info.open
    ? `Ciclo aberto. Dia ${info.daysElapsed+1} de 30. Edi√ß√µes permitidas at√© ${info.daysRemaining>5 ? (info.daysRemaining+' dias antes do fechamento') : 'bloqueadas (√∫ltimos 5 dias)'}.`
    : `Per√≠odo de 30 dias encerrado. Para novo ciclo, contate o administrador.`;
  $('#cycleTag').textContent = info.open ? `Ciclo ${info.cycleId} (aberto)` : `Ciclo ${info.cycleId} (encerrado)`;
}

/* ======= LOGS ======= */
async function logEvent(tipo, descricao, detalhes={}){
  try{
    const payload={ tipo, descricao, detalhes:detalhes||{}, user: currentUser?.user || 'anon', userNome: currentUser?.nome || 'An√¥nimo', ts: Date.now() };
    await db.ref('logs').push(payload);
  }catch(e){ console.warn('log fail',e); }
}

/* ======= PRODUTOS ======= */
async function seedProdutos(){
  try{
    const snap = await db.ref('produtos').once('value');
    if(snap.exists()) return;
    const iniciais=[
      { nome:'Copo descart√°vel 100 un', unidade:'pacote' },
      { nome:'Toalha papel interfolha 1000 folhas', unidade:'pacote' },
      { nome:'Papel higi√™nico 300m', unidade:'rolo' },
      { nome:'Toalha papel 200m', unidade:'rolo' },
      { nome:'Papel higi√™nico 60m c/12', unidade:'pacote' },
    ];
    for(const p of iniciais) await db.ref('produtos').push(p);
  }catch(e){}
}
async function loadProdutos(){
  try{
    const snap = await db.ref('produtos').once('value');
    const obj = snap.val()||{};
    produtosCache = Object.keys(obj).map(k=>({ key:k, ...obj[k] }));
    // ordenar alfabeticamente por nome
    produtosCache.sort((a,b)=> normalize(a.nome).localeCompare(normalize(b.nome)));
    renderProdutosAdminTabelas();
  }catch(e){ console.error('loadProdutos',e); }
}
function renderProdutosAdminTabelas(){
  const tbody = $('#tabelaProdutosAdmin tbody'); const tbodyList = $('#tabelaProdutosAdminList tbody');
  if(tbody){ tbody.innerHTML=''; produtosCache.forEach(p=>{ const tr=document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.nome)}</td><td>${escapeHtml(p.unidade||'')}</td>
      <td class="actions">
        <button class="small" onclick="adminEditProduto('${p.key}')">Editar</button>
        <button class="small" onclick="adminDeleteProduto('${p.key}')">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });}
  if(tbodyList){ tbodyList.innerHTML=''; produtosCache.forEach(p=>{ const tr=document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.nome)}</td><td>${escapeHtml(p.unidade||'')}</td>
      <td class="actions">
        <button class="small" onclick="adminEditProduto('${p.key}')">Editar</button>
        <button class="small" onclick="adminDeleteProduto('${p.key}')">Excluir</button>
      </td>`;
    tbodyList.appendChild(tr);
  });}
}
window.adminEditProduto = async function(key){
  try{
    const p = produtosCache.find(x=>x.key===key); if(!p) return;
    const novoNome = prompt('Novo nome:', p.nome); if(novoNome===null) return;
    const novaUn = prompt('Unidade:', p.unidade||''); if(novaUn===null) return;
    await db.ref('produtos/'+key).update({ nome: novoNome.trim(), unidade: novaUn.trim() });
    await loadProdutos(); showToast('Produto atualizado','info'); await logEvent('sistema','Produto atualizado',{produto:key});
  }catch(e){ showToast('Erro ao editar produto','error'); }
};
window.adminDeleteProduto = async function(key){
  try{
    if(!confirm('Excluir este produto?')) return;
    await db.ref('produtos/'+key).remove(); await loadProdutos(); showToast('Produto exclu√≠do','info'); await logEvent('sistema','Produto exclu√≠do',{produto:key});
  }catch(e){ showToast('Erro ao excluir produto','error'); }
};

/* ======= CEP (ViaCEP) ======= */
async function buscaCEP(cep){
  cep = (cep||'').replace(/\D/g,'');
  if(cep.length!==8) throw new Error('CEP inv√°lido');
  const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
  const data = await resp.json();
  if(data.erro) throw new Error('CEP n√£o encontrado');
  return data; // {logradouro,bairro,localidade,uf}
}

/* ======= AUTENTICA√á√ÉO ======= */
async function register(usuario){
  // usado no primeiro acesso para concluir cadastro
  // usuario: {nome, user, pass, localidade, ministerio, genero}
  const msgEl = $('#paMsg'); msgEl.textContent='';
  try{
    // checar duplicidade de user
    const snap = await db.ref('usuarios').orderByChild('user').equalTo(usuario.user).once('value');
    if(snap.exists()){ msgEl.style.color='red'; msgEl.textContent='Nome de usu√°rio j√° existe.'; return false; }
    const uid = Date.now().toString(36) + Math.random().toString(36).substring(2,8);
    await db.ref('usuarios').push({
      nome: usuario.nome, localidade: usuario.localidade, user: usuario.user, pass: usuario.pass,
      ministerio: usuario.ministerio||'', genero: usuario.genero||'auto', uid, createdAt: Date.now(), provisorio: false
    });
    msgEl.style.color='green'; msgEl.textContent='Cadastro conclu√≠do com sucesso.';
    await logEvent('perfil','Cadastro conclu√≠do',{user:usuario.user});
    return true;
  }catch(e){ console.error('register',e); msgEl.style.color='red'; msgEl.textContent='Erro ao salvar usu√°rio.'; return false; }
}

async function login(){
  const user = $('#loginUser').value.trim();
  const pass = $('#loginPass').value.trim();
  const errEl = $('#loginError'); errEl.textContent='';
  if(!user || !pass){ showToast('‚ö†Ô∏è Preencha todos os campos!','warn'); return; }

  // Admin direto
  if(user===ADMIN_LOGIN && pass===ADMIN_PASSWORD){
    currentUser = { user: ADMIN_LOGIN, nome:'Administrador', localidade:'Administra√ß√£o', genero:'M', isAdmin:true, provisorio:false };
    await logEvent('login','Admin logou',{user:ADMIN_LOGIN});
    playChime('login');
    await msgTransicao("A paz de Deus, irm√£o Administrador...!\n√â muito importante seu zelo com a irmandade e com a obra de Deus!\nFa√ßa bom proveito dos itens que o Senhor Deus est√° disponibilizando para compras.", 10000);
    enterApp(); return;
  }

  try{
    // 1) Tenta achar usu√°rio normal
    let snap = await db.ref('usuarios').orderByChild('user').equalTo(user).once('value');
    const users = snap.val();
    if(users){
      const key = Object.keys(users)[0]; const found = users[key];
      if((found.pass||found.senha) !== pass){ showToast('üîí Senha incorreta!','error'); return; }
      currentUser = {
        user: found.user, nome: found.nome, localidade: found.localidade, genero: found.genero||'auto',
        ministerio: found.ministerio||'', isAdmin: (found.user===ADMIN_LOGIN), uid: found.uid||key, provisorio: !!found.provisorio
      };
      await logEvent('login','Usu√°rio logou',{user:found.user});
      playChime('login');

      if(currentUser.provisorio){
        // for√ßa completar cadastro
        go('primeiroAcessoScreen');
        $('#paNome').value = currentUser.nome||'';
        $('#paUser').value = currentUser.user||'';
        $('#paPass').value = '';
        $('#paLogradouro').value=''; $('#paBairro').value=''; $('#paCidade').value=currentUser.localidade||''; $('#paUf').value='';
        $('#paOutraLocalidade').checked=false; togglePAOutraLocalidade(false);
        return;
      }

      const msg = saudacaoLogin(currentUser.nome, currentUser.genero||'auto');
      await msgTransicao(msg, 10000);
      enterApp(); return;
    }

    // 2) N√£o achou -> erro
    showToast('‚ö†Ô∏è Usu√°rio n√£o encontrado!','error',4000);
  }catch(e){
    console.error('erro login', e);
    errEl.textContent='Erro ao autenticar. Veja console.';
  }
}

function logout(){
  const name = currentUser?.nome || '';
  const gen = currentUser?.genero || 'auto';
  const msg = saudacaoSaida(name, gen);
  currentUser = null; sessionStorage.removeItem('ccb_user');
  go('loginScreen');
  $('#loginUser').value=''; $('#loginPass').value='';
  msgTransicao(msg, 10000).then(()=> showToast('Saindo...', 'info', 1500));
  logEvent('logout','Usu√°rio saiu',{nome:name});
  playChime('logout');
}

function enterApp(){
  sessionStorage.setItem('ccb_user', JSON.stringify(currentUser));
  go('pedidoScreen');
  $('#pedidoMsg').textContent='';
  if(currentUser.isAdmin || currentUser.user===ADMIN_LOGIN){
    ['adminRelatorioBtn','adminProdutosBtn','adminUsuariosBtn','adminHistoricoBtn'].forEach(id=> $('#'+id)?.classList.remove('hidden'));
  }else{
    ['adminRelatorioBtn','adminProdutosBtn','adminUsuariosBtn','adminHistoricoBtn'].forEach(id=> $('#'+id)?.classList.add('hidden'));
  }
  updateCycleInfoUI();
}

/* ======= BUSCA PRODUTOS (alfab√©tica - come√ßa com) ======= */
function filtrarProdutos(){
  const q = normalize($('#buscaProduto').value.trim());
  const lista = $('#listaProdutos'); lista.innerHTML=''; selectedProductKey = null;
  if(!q){ lista.style.display='none'; return; }
  const matches = produtosCache.filter(p => normalize(p.nome).startsWith(q));
  if(matches.length === 0){ lista.innerHTML = '<div>Nenhum produto</div>'; lista.style.display='block'; return; }
  matches.forEach(m=>{
    const div = document.createElement('div');
    div.textContent = `${m.nome} (${m.unidade||''})`;
    div.onclick = ()=>{ selectedProductKey = m.key; $('#buscaProduto').value = `${m.nome} (${m.unidade||''})`; lista.style.display='none'; showToast('Produto selecionado: '+m.nome, 'info', 1200); };
    lista.appendChild(div);
  });
  lista.style.display='block';
}

/* ======= PEDIDOS ======= */
async function salvarPedido(){
  const produtoKey = selectedProductKey;
  const produtoText = $('#buscaProduto').value.trim();
  const quantidade = $('#quantidade').value.trim();
  const obs = $('#obs').value.trim();
  const msgEl = $('#pedidoMsg'); msgEl.textContent='';
  if(!produtoKey || !produtoText){ msgEl.style.color='red'; msgEl.textContent='Selecione um produto.'; return; }
  if(!quantidade || parseInt(quantidade)<=0){ msgEl.style.color='red'; msgEl.textContent='Quantidade inv√°lida.'; return; }
  if(!currentUser){ msgEl.style.color='red'; msgEl.textContent='Voc√™ precisa estar logado.'; return; }
  const cycle = await getCycleInfo();
  if(!cycle.open){ msgEl.style.color='red'; msgEl.textContent='Per√≠odo de pedidos encerrado.'; return; }
  if(cycle.daysRemaining<=5){ msgEl.style.color='red'; msgEl.textContent='N√£o √© poss√≠vel criar/editar nos √∫ltimos 5 dias do ciclo.'; return; }

  try{
    const snap = await db.ref('pedidos').orderByChild('createdBy').equalTo(currentUser.user).once('value');
    const data = snap.val()||{}; const rows = Object.keys(data).map(k=>({ key:k, ...data[k] }));
    const same = rows.find(r=> r.produtoKey===produtoKey && !r.entregue && (r.cycleId||monthIdFrom(r.createdAt||Date.now()))===cycle.cycleId);
    if(same){
      const novaQtd = Number(same.quantidade||0) + Number(quantidade);
      await db.ref('pedidos/'+same.key).update({ quantidade: novaQtd, obs: obs ? (same.obs ? `${same.obs}; ${obs}` : obs) : (same.obs||''), updatedAt: Date.now() });
      await logEvent('pedido','Quantidade somada a pedido existente',{pedidoKey:same.key,produtoKey,addQtd:Number(quantidade),total:novaQtd});
      msgEl.style.color='green'; msgEl.textContent='Quantidade somada ao pedido em aberto.';
    }else{
      const pedido={ produtoKey, produtoText, quantidade: parseInt(quantidade), obs, createdBy: currentUser.user, createdByUid: currentUser.uid||'', createdByName: currentUser.nome, createdByLocalidade: currentUser.localidade,
        createdAt: Date.now(), entregue:false, deliveredAt:null, cycleId: cycle.cycleId, cycleStart: cycle.start };
      await db.ref('pedidos').push(pedido);
      await logEvent('pedido','Pedido criado',{produtoKey, quantidade:Number(quantidade)});
      msgEl.style.color='green'; msgEl.textContent='Pedido enviado com sucesso.';
    }
    $('#buscaProduto').value=''; selectedProductKey=null; $('#quantidade').value=''; $('#obs').value='';
    showToast('Pedido salvo','info');
  }catch(e){ console.error('salvarPedido',e); msgEl.style.color='red'; msgEl.textContent='Erro ao salvar pedido.'; }
}

async function mostrarPedidosUsuario(status='todos'){
  if(!currentUser){ alert('Fa√ßa login primeiro.'); return; }
  go('relatorioUsuario');
  const tbody=$('#tabelaPedidosUsuario tbody'); tbody.innerHTML='<tr><td colspan="6">Carregando...</td></tr>';
  try{
    const [snap, cycle] = await Promise.all([
      db.ref('pedidos').orderByChild('createdBy').equalTo(currentUser.user).once('value'),
      getCycleInfo()
    ]);
    const data = snap.val()||{}; let rows = Object.keys(data).map((k,i)=>({ idx:i+1, key:k, ...data[k] }));
    if(status==='aberto') rows = rows.filter(r=>!r.entregue);
    if(status==='entregue') rows = rows.filter(r=>r.entregue);
    if($('#toggleOcultarEntreguesUsuario2').checked) rows = rows.filter(r=>!r.entregue);
    tbody.innerHTML = rows.length?'':'<tr><td colspan="6">Nenhum pedido encontrado.</td></tr>';
    const canEditByCycle = cycle.open && cycle.daysRemaining>5;
    rows.forEach((r,i)=>{
      const tr=document.createElement('tr'); if(r.entregue) tr.classList.add('delivered');
      const canEdit = (r.createdBy===currentUser.user) && canEditByCycle && !r.entregue;
      const canDelete = canEdit;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(r.produtoText||'')}</td>
        <td>${escapeHtml(r.quantidade||'')}</td>
        <td>${escapeHtml(r.obs||'')}</td>
        <td>${r.entregue?'<span class="status-entregue">Entregue</span>':'<span class="status-aberto">Aberto</span>'}</td>
        <td class="actions"></td>`;
      const act = tr.querySelector('.actions');
      if(canEdit){ const b=document.createElement('button'); b.className='small'; b.textContent='Editar'; b.onclick=()=>editPedido(r.key); act.appendChild(b); }
      if(canDelete){ const b=document.createElement('button'); b.className='small'; b.textContent='Excluir'; b.onclick=()=>deletePedido(r.key,{origin:'user'}); act.appendChild(b); }
      tbody.appendChild(tr);
    });
  }catch(e){ console.error('mostrarPedidosUsuario',e); tbody.innerHTML='<tr><td colspan="6">Erro ao carregar.</td></tr>'; }
}

async function editPedido(key){
  try{
    const snap = await db.ref('pedidos/'+key).once('value'); const p=snap.val(); if(!p) return;
    const cycle = await getCycleInfo();
    const canEdit = currentUser && (p.createdBy===currentUser.user) && cycle.open && cycle.daysRemaining>5 && !p.entregue;
    if(!canEdit){ showToast('Edi√ß√£o n√£o permitida','error'); return; }
    const novaQtd = prompt('Quantidade:', p.quantidade||''); if(novaQtd===null || parseInt(novaQtd)<=0){ showToast('Quantidade inv√°lida','error'); return; }
    const novoObs = prompt('Observa√ß√µes:', p.obs||''); if(novoObs===null) return;
    await db.ref('pedidos/'+key).update({ quantidade: parseInt(novaQtd), obs: novoObs, updatedAt: Date.now() });
    await logEvent('pedido','Pedido atualizado',{pedidoKey:key});
    showToast('Pedido atualizado','info'); mostrarPedidosUsuario($('#filtroUsuario').value||'todos');
  }catch(e){ showToast('Erro ao editar pedido','error'); }
}

async function deletePedido(key, opts={origin:'user'}){
  try{
    const snap = await db.ref('pedidos/'+key).once('value'); const p=snap.val(); if(!p) return;
    const cycle = await getCycleInfo(); const isAdmin=!!currentUser?.isAdmin;
    let allowed=false; let reason='';
    if(!p.entregue){
      if((p.createdBy===currentUser?.user) && cycle.open && cycle.daysRemaining>5) allowed=true;
      if(isAdmin) allowed=true;
    }else{
      if(isAdmin){
        const aYear=365*24*60*60*1000;
        if(Date.now()-(p.deliveredAt||0) >= aYear) allowed=true; else reason='Pedido entregue h√° menos de 1 ano.';
      }else reason='Pedidos entregues s√≥ podem ser exclu√≠dos pelo administrador.';
    }
    if(!allowed){ showToast('Exclus√£o n√£o permitida'+(reason?': '+reason:''),'error'); return; }
    if(!confirm('Deseja realmente excluir este pedido?')) return;
    await db.ref('pedidos/'+key).remove(); await logEvent('pedido','Pedido exclu√≠do',{pedidoKey:key});
    showToast('Pedido exclu√≠do','info');
    if(opts.origin==='admin'){ if(lastScreen==='relatorioAdmin') verRelatorioAdmin($('#filtroAdmin').value||'todos'); }
    else mostrarPedidosUsuario($('#filtroUsuario').value||'todos');
  }catch(e){ showToast('Erro ao excluir pedido','error'); }
}

/* ======= RELAT√ìRIOS (ADMIN) ======= */
async function verRelatorioAdmin(status='todos'){
  if(!currentUser || !currentUser.isAdmin){ alert('Acesso negado.'); return; }
  go('relatorioAdmin');
await atualizarStatusCiclo();

  const tbodyP=$('#tabelaPedidosAdmin tbody'); const tbodyU=$('#tabelaUsuariosAdmin tbody');
  const tabelaResumo=$('#tabelaProdutosAdmin tbody');
  tbodyP.innerHTML='<tr><td colspan="8">Carregando...</td></tr>';
  tbodyU.innerHTML='<tr><td colspan="6">Carregando...</td></tr>';
  tabelaResumo.innerHTML='<tr><td colspan="3">Carregando...</td></tr>';
  try{
    const [snapP, snapU] = await Promise.all([ db.ref('pedidos').once('value'), db.ref('usuarios').once('value') ]);
    const pedidosObj = snapP.val()||{}; let pedidos = Object.keys(pedidosObj).map((k,i)=>({ idx:i+1, key:k, ...pedidosObj[k] }));
    const usuariosObj = snapU.val()||{}; const usuarios = Object.keys(usuariosObj).map(k=>({ key:k, ...usuariosObj[k] }));

    if(status==='aberto') pedidos = pedidos.filter(p=>!p.entregue);
    if(status==='entregue') pedidos = pedidos.filter(p=>p.entregue);
    if($('#toggleOcultarEntreguesAdmin').checked) pedidos = pedidos.filter(p=>!p.entregue);

    // Tabela Pedidos
    tbodyP.innerHTML = pedidos.length?'':'<tr><td colspan="8">Nenhum pedido encontrado.</td></tr>';
    let totAbertos=0, totEntregues=0;
    pedidos.forEach((p,i)=>{
      if(p.entregue) totEntregues++; else totAbertos++;
      const tr=document.createElement('tr'); if(p.entregue) tr.classList.add('delivered');
      const canDeliveredDelete = p.entregue && p.deliveredAt && (Date.now()-p.deliveredAt >= 365*24*60*60*1000);
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(p.createdByName||p.createdBy||'')}</td>
        <td>${escapeHtml(p.createdByLocalidade||'')}</td>
        <td>${escapeHtml(p.produtoText||'')}</td>
        <td>${escapeHtml(p.quantidade||'')}</td>
        <td>${escapeHtml(p.obs||'')}</td>
        <td>${p.entregue?'<span class="status-entregue">Entregue</span>':'<span class="status-aberto">Aberto</span>'}</td>
        <td class="actions"></td>`;
      const act = tr.querySelector('.actions');
      const btnToggle=document.createElement('button'); btnToggle.className='small';
      if(p.entregue){ btnToggle.textContent='Desmarcar'; btnToggle.onclick=()=>toggleEntregue(p.key,false); }
      else{ btnToggle.textContent='Marcar entregue'; btnToggle.onclick=()=>toggleEntregue(p.key,true); }
      act.appendChild(btnToggle);
      if(!p.entregue || canDeliveredDelete){

        const b=document.createElement('button'); b.className='small'; b.textContent='Excluir'; b.onclick=()=>deletePedido(p.key,{origin:'admin'}); act.appendChild(b);
      }
      tbodyP.appendChild(tr);
    });
    $('#resumoAbertos').textContent = 'Abertos: '+totAbertos;
    $('#resumoEntregues').textContent = 'Entregues: '+totEntregues;
    $('#resumoTotal').textContent = 'Total: '+(totAbertos+totEntregues);

    // Tabela Usu√°rios
    tbodyU.innerHTML = '';
    usuarios.forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(u.nome||'')}</td><td>${escapeHtml(u.user||'')}</td><td>${escapeHtml(u.localidade||'')}</td><td>${escapeHtml(u.ministerio||'')}</td>
        <td>${u.provisorio?'SIM':'N√ÉO'}</td>
        <td class="actions">
          <button class="small" onclick="adminEditUser('${u.key}')">Editar</button>
          <button class="small" onclick="adminDeleteUser('${u.key}')">Excluir</button>
        </td>`;
      tbodyU.appendChild(tr);
    });

    // Resumo Itens ‚Äì agora somente ABERTOS (baixa ao entregar)
    const map={};
    Object.values(pedidosObj).forEach(p=>{ if(!p.entregue){ const name=p.produtoText||'Sem produto'; map[name]=(map[name]||0)+Number(p.quantidade||0); } });
    tabelaResumo.innerHTML='';
    Object.keys(map).sort((a,b)=>normalize(a).localeCompare(normalize(b))).forEach(name=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(map[name])}</td>
        <td class="actions">
          <button class="small" onclick="adminEditProdutoBusca('${escapeHtml(name)}')">Editar Nome</button>
        </td>`;
      tabelaResumo.appendChild(tr);
    });
  }catch(e){
    console.error('verRelatorioAdmin',e);
    tbodyP.innerHTML='<tr><td colspan="8">Erro ao carregar pedidos.</td></tr>';
    tbodyU.innerHTML='<tr><td colspan="6">Erro ao carregar usu√°rios.</td></tr>';
    tabelaResumo.innerHTML='<tr><td colspan="3">Erro.</td></tr>';
  }
}
window.adminEditProdutoBusca = function(nome){ alert('Edite o produto na aba Produtos (Admin). Nome: '+nome); };

async function toggleEntregue(key, toState){
  if(!currentUser?.isAdmin){ showToast('Acesso negado','error'); return; }
  if(!confirm('Confirmar?')) return;
  const senha = prompt('Senha de administrador:'); if(senha!==ADMIN_PASSWORD){ showToast('Senha incorreta','error'); return; }
  try{
    const updates = { entregue: !!toState };
    if(toState){ updates.deliveredAt = Date.now(); } else { updates.deliveredAt = null; }
    await db.ref('pedidos/'+key).update(updates);
// === Atualiza automaticamente o estoque do usu√°rio ===
if (toState) {
  try {
    const pedidoSnap = await db.ref('pedidos/' + key).once('value');
    const pedido = pedidoSnap.val();
    if (pedido) {
      const uid = pedido.createdByUid || pedido.createdBy;
      const produtoId = pedido.produtoKey;
      const produtoNome = pedido.produtoText;
      const qtd = Number(pedido.quantidade) || 0;
      const local = pedido.createdByLocalidade || 'N√£o informado';
      const ciclo = pedido.cycleId || 'Sem ciclo';

      const refEstoque = db.ref(`estoques/${uid}/${produtoId}`);
      const snapEstoque = await refEstoque.once('value');
      const atual = snapEstoque.exists() ? snapEstoque.val().quantidade || 0 : 0;

      await refEstoque.set({
        nome: produtoNome,
        quantidade: atual + qtd,
        localidade: local,
        ultimaEntrada: new Date().toLocaleString('pt-BR'),
        ciclo: ciclo
      });

      // registrar movimenta√ß√£o
      const movRef = db.ref(`movimentacoes/${uid}`).push();
      await movRef.set({
        tipo: 'entrada',
        produto: produtoNome,
        qtd: qtd,
        ciclo: ciclo,
        data: new Date().toLocaleString('pt-BR'),
        origem: 'entrega_admin'
      });

      console.log(`‚úÖ Estoque de ${produtoNome} atualizado para o usu√°rio ${uid}`);
    }
  } catch (e) {
    console.error('Erro ao atualizar estoque autom√°tico:', e);
  }
}

    await logEvent('pedido', toState?'Pedido marcado entregue':'Pedido desmarcado entregue',{pedidoKey:key});
    // Recarrega a mesma tela sem precisar sair
    if(lastScreen==='relatorioAdmin') verRelatorioAdmin($('#filtroAdmin').value||'todos');
    else if(lastScreen==='relatorioUsuario') mostrarPedidosUsuario($('#filtroUsuario').value||'todos');
    else go('pedidoScreen');
    showToast('Atualizado','info');
  }catch(e){ showToast('Erro ao atualizar','error'); }
}

/* ======= ADMIN ‚Äì Usu√°rios ======= */
function abrirCadastroUsuarioAdmin(){ go('adminUsuarios'); renderAdminUsuarios(); }
function abrirCadastroProduto(){ go('adminProdutos'); }

async function adminAddUser(){
  if(!currentUser?.isAdmin){ showToast('Acesso negado','error'); return; }
  const nome=$('#adminNovoNome').value.trim();
  const user=$('#adminNovoUser').value.trim();
  const pass=$('#adminNovoPass').value.trim();
  const localidade=$('#adminNovoLocalidade').value.trim();
  const ministerio=$('#adminNovoMinisterio').value||'';
  const provisorio = $('#adminProvisorio').value==='true';
  if(!nome || !user || !pass){ showToast('Preencha: nome, usu√°rio, senha','error'); return; }
  try{
    const snap = await db.ref('usuarios').orderByChild('user').equalTo(user).once('value');
    if(snap.exists()){ showToast('Usu√°rio j√° existe','error'); return; }
    const uid = Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    await db.ref('usuarios').push({ nome, user, pass, localidade, ministerio, genero:'auto', uid, createdAt: Date.now(), provisorio });
    $('#adminNovoNome').value=''; $('#adminNovoUser').value=''; $('#adminNovoPass').value=''; $('#adminNovoLocalidade').value='';
    await renderAdminUsuarios(); showToast('Usu√°rio criado','info'); await logEvent('perfil','Usu√°rio criado (admin)',{user});
  }catch(e){ showToast('Erro ao criar usu√°rio','error'); }
}
async function renderAdminUsuarios(){
  try{
    const tbody=$('#tabelaUsuariosAdmin tbody'); if(!tbody) return;
    const snap = await db.ref('usuarios').once('value'); const obj=snap.val()||{}; const usuarios=Object.keys(obj).map(k=>({ key:k, ...obj[k] }));
    tbody.innerHTML=''; const tbody2=$('#tabelaAdminUsuariosList tbody'); if(tbody2) tbody2.innerHTML='';
    usuarios.forEach(u=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(u.nome||'')}</td><td>${escapeHtml(u.user||'')}</td><td>${escapeHtml(u.localidade||'')}</td><td>${escapeHtml(u.ministerio||'')}</td>
        <td>${u.provisorio?'SIM':'N√ÉO'}</td>
        <td class="actions">
          <button class="small" onclick="adminEditUser('${u.key}')">Editar</button>
          <button class="small" onclick="adminDeleteUser('${u.key}')">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
      if(tbody2){ const tr2=document.createElement('tr'); tr2.innerHTML=tr.innerHTML; tbody2.appendChild(tr2); }
    });
  }catch(e){ console.error('renderAdminUsuarios',e); }
}
window.adminEditUser = async function(key){
  try{
    const snap = await db.ref('usuarios/'+key).once('value'); const u=snap.val(); if(!u) return;
    const novoNome = prompt('Nome:', u.nome||''); if(novoNome===null) return;
    const novoUser = prompt('Usu√°rio:', u.user||''); if(novoUser===null) return;
    const novaLoc = prompt('Localidade:', u.localidade||''); if(novaLoc===null) return;
    const novaMin = prompt('Minist√©rio:', u.ministerio||''); if(novaMin===null) return;
    const provisorioStr = prompt('Provis√≥rio? (SIM/NAO):', u.provisorio?'SIM':'NAO'); if(provisorioStr===null) return;
    const novaPass = prompt('Senha (deixe vazio para manter):','');
    const updates = { nome:novoNome.trim(), user:novoUser.trim(), localidade:novaLoc.trim(), ministerio:novaMin.trim(), provisorio:(provisorioStr||'NAO').toUpperCase()==='SIM', updatedAt: Date.now() };
    if(novaPass && novaPass.trim()){ updates.pass=novaPass.trim(); await logEvent('perfil','Senha alterada (admin)',{user:novoUser.trim()}); }
    await db.ref('usuarios/'+key).update(updates); await renderAdminUsuarios(); showToast('Usu√°rio atualizado','info');
  }catch(e){ showToast('Erro ao editar usu√°rio','error'); }
};
window.adminDeleteUser = async function(key){
  try{
    if(!confirm('Excluir este usu√°rio?')) return;
    await db.ref('usuarios/'+key).remove(); await renderAdminUsuarios(); showToast('Usu√°rio exclu√≠do','info');
    await logEvent('perfil','Usu√°rio exclu√≠do (admin)',{userKey:key});
  }catch(e){ showToast('Erro ao excluir usu√°rio','error'); }
};

/* ======= ADMIN ‚Äì Produtos ======= */
async function addProduto(){
  if(!currentUser?.isAdmin){ showToast('Acesso negado','error'); return; }
  const nome=$('#novoProdutoNome').value.trim(); const unidade=$('#novoProdutoUnidade').value.trim();
  if(!nome || !unidade){ showToast('Preencha nome e unidade','error'); return; }
  try{
    await db.ref('produtos').push({ nome, unidade }); $('#novoProdutoNome').value=''; $('#novoProdutoUnidade').value='';
    await loadProdutos(); showToast('Produto adicionado','info'); await logEvent('sistema','Produto adicionado',{nome,unidade});
  }catch(e){ showToast('Erro ao adicionar produto','error'); }
}

/* ======= HIST√ìRICO (ADMIN) ======= */
async function abrirHistoricoAdmin(){ if(!currentUser?.isAdmin){ alert('Acesso negado.'); return; } go('historicoAdmin'); await carregarHistoricoAdmin(); }
async function carregarHistoricoAdmin(){
  const tbody=$('#tabelaHistoricoAdmin tbody'); tbody.innerHTML='<tr><td colspan="5">Carregando‚Ä¶</td></tr>';
  try{
    const snap = await db.ref('logs').orderByChild('ts').limitToLast(500).once('value');
    const obj=snap.val()||{}; let rows = Object.keys(obj).map(k=>({ key:k, ...obj[k] })).sort((a,b)=> b.ts-a.ts);
    const tipoSel = $('#filtroHistoricoTipo').value||'todos';
    if(tipoSel!=='todos') rows = rows.filter(r=>r.tipo===tipoSel);
    if($('#toggleOcultarHistorico').checked){ rows=[]; }
    tbody.innerHTML = rows.length?'':'<tr><td colspan="5">Sem eventos</td></tr>';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmtDateTime(r.ts)}</td><td>${escapeHtml(r.userNome||r.user||'-')}</td><td>${escapeHtml(r.tipo||'-')}</td><td>${escapeHtml(r.descricao||'-')}</td>
        <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(JSON.stringify(r.detalhes||{},null,0))}</pre></td>`;
      tbody.appendChild(tr);
    });
    // KPIs
    const now=Date.now(); const dayStart=new Date(); dayStart.setHours(0,0,0,0);
    const last30 = now - 30*24*60*60*1000;
    $('#kpiEvt30').textContent = Object.values(obj).filter(r=> r.ts>=last30).length;
    $('#kpiLoginHoje').textContent = Object.values(obj).filter(r=> r.tipo==='login' && r.ts>=dayStart.getTime()).length;
    $('#kpiPedidosHoje').textContent = Object.values(obj).filter(r=> r.tipo==='pedido' && (r.descricao||'').toLowerCase().includes('pedido criado') && r.ts>=dayStart.getTime()).length;
    $('#kpiPwd30').textContent = Object.values(obj).filter(r=> r.tipo==='perfil' && (r.descricao||'').toLowerCase().includes('senha') && r.ts>=last30).length;
  }catch(e){ tbody.innerHTML='<tr><td colspan="5">Erro ao carregar.</td></tr>'; }
}

/* ======= IMPRESS√ÉO / PREVIEW / INTERVALO ======= */
function parseIntervalo(text){
  if(!text) return null;
  // "1-3,6,10-12"
  const parts = text.split(',').map(s=>s.trim()).filter(Boolean);
  const idxs = new Set();
  for(const part of parts){
    if(/^\d+$/.test(part)){ idxs.add(parseInt(part)); }
    else if(/^\d+\-\d+$/.test(part)){
      const [a,b]=part.split('-').map(n=>parseInt(n));
      const start=Math.min(a,b), end=Math.max(a,b);
      for(let i=start;i<=end;i++) idxs.add(i);
    }
  }
  return idxs.size? idxs : null;
}
function buildPrintTableFromDom(domRows, intervalSet, isAdmin=false){
  const rows=[];
  domRows.forEach((r,i)=>{
    const idx=i+1; if(intervalSet && !intervalSet.has(idx)) return;
    const cols=r.querySelectorAll('td'); if(cols.length===0) return;
    if(isAdmin){
      rows.push(`<tr>
        <td style="border:1px solid #ddd;padding:6px;">${idx}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[1].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[2].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[3].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[4].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[5].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[6].innerText)}</td>
        <td class="check-col" style="border:1px solid #ddd;">[  ]</td>
      </tr>`);
    }else{
      rows.push(`<tr>
        <td style="border:1px solid #ddd;padding:6px;">${idx}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[1].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[2].innerText)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(cols[3].innerText)}</td>
        <td class="check-col" style="border:1px solid #ddd;">[  ]</td>
      </tr>`);
    }
  });
  return rows.join('');
}
function printHtml(html, title='Impress√£o'){
  const w = window.open('','_blank');
  const totalCss = `
    body{font-family:Arial,sans-serif;padding:20px;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;}
    th{background:#0056b3;color:#fff;}
    .check-col{width:120px;text-align:center;}
    .signature-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px;}
    .signature-box{border-top:1px solid #000;padding-top:6px;text-align:center;font-size:12px;}
    @media print {.no-print{display:none}}
  `;
  const doc = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(title)}</title><style>${totalCss}</style></head><body>${html}</body></html>`;
  w.document.write(doc); w.document.close(); w.focus(); setTimeout(()=> w.print(), 300);
}

function previewRelUsuario(){
  const interval = parseIntervalo($('#ruIntervalo').value.trim());
  const tpl = $('#tpl-impressao-usuario').content.cloneNode(true);
  tpl.querySelector('#print-meta-usuario').textContent = `Gerado em ${fmtDateTime(Date.now())}`;
  tpl.querySelector('#print-solicitante').textContent = `Solicitante: ${currentUser?.nome||'-'} (${currentUser?.user||'-'})`;
  tpl.querySelector('#print-localidade').textContent = `Localidade: ${currentUser?.localidade||'-'}`;
  tpl.querySelector('#print-ministerio').textContent = `Minist√©rio: ${currentUser?.ministerio||'-'}`;
  getCycleInfo().then(info=> tpl.querySelector('#print-ciclo').textContent = `Ciclo: ${info.cycleId}`);
  const rowsDom = $$('#tabelaPedidosUsuario tbody tr');
  const body = buildPrintTableFromDom(rowsDom, interval, false);
  tpl.querySelector('#print-tbody-usuario').innerHTML = body || '<tr><td colspan="5">Sem dados</td></tr>';
  abrirModal('Pr√©-visualiza√ß√£o ‚Äì Meus Pedidos', tpl.firstElementChild.outerHTML);
}
function imprimirRelatorioUsuario(){
  const interval = parseIntervalo($('#ruIntervalo').value.trim());
  const tpl = $('#tpl-impressao-usuario').content.cloneNode(true);
  tpl.querySelector('#print-meta-usuario').textContent = `Gerado em ${fmtDateTime(Date.now())}`;
  tpl.querySelector('#print-solicitante').textContent = `Solicitante: ${currentUser?.nome||'-'} (${currentUser?.user||'-'})`;
  tpl.querySelector('#print-localidade').textContent = `Localidade: ${currentUser?.localidade||'-'}`;
  tpl.querySelector('#print-ministerio').textContent = `Minist√©rio: ${currentUser?.ministerio||'-'}`;
  getCycleInfo().then(info=> tpl.querySelector('#print-ciclo').textContent = `Ciclo: ${info.cycleId}`);
  const rowsDom = $$('#tabelaPedidosUsuario tbody tr');
  const body = buildPrintTableFromDom(rowsDom, interval, false);
  tpl.querySelector('#print-tbody-usuario').innerHTML = body || '<tr><td colspan="5">Sem dados</td></tr>';
  printHtml(tpl.firstElementChild.outerHTML, 'Meus Pedidos');
}

function previewRelGeral(){
  const interval = parseIntervalo($('#raIntervalo').value.trim());
  const tpl = $('#tpl-impressao-geral').content.cloneNode(true);
  tpl.querySelector('#print-meta-geral').textContent = `Gerado em ${fmtDateTime(Date.now())}`;
  getCycleInfo().then(info=> tpl.querySelector('#print-ciclo-geral').textContent = `Ciclo: ${info.cycleId}`);
  const rowsDom = $$('#tabelaPedidosAdmin tbody tr');
  const body = buildPrintTableFromDom(rowsDom, interval, true);
  tpl.querySelector('#print-tbody-geral').innerHTML = body || '<tr><td colspan="8">Sem dados</td></tr>';
  abrirModal('Pr√©-visualiza√ß√£o ‚Äì Relat√≥rio Geral', tpl.firstElementChild.outerHTML);
}
function imprimirRelatorioAdmin(){
  const interval = parseIntervalo($('#raIntervalo').value.trim());
  const tpl = $('#tpl-impressao-geral').content.cloneNode(true);
  tpl.querySelector('#print-meta-geral').textContent = `Gerado em ${fmtDateTime(Date.now())}`;
  getCycleInfo().then(info=> tpl.querySelector('#print-ciclo-geral').textContent = `Ciclo: ${info.cycleId}`);
  const rowsDom = $$('#tabelaPedidosAdmin tbody tr');
  const body = buildPrintTableFromDom(rowsDom, interval, true);
  tpl.querySelector('#print-tbody-geral').innerHTML = body || '<tr><td colspan="8">Sem dados</td></tr>';
  printHtml(tpl.firstElementChild.outerHTML, 'Relat√≥rio de Pedidos - Geral');
}

async function imprimirRelatorioPorLocalidade(){
  try{
    const snap = await db.ref('usuarios').once('value'); const obj=snap.val()||{};
    const usuarios = Object.keys(obj).map(k=>({ key:k, ...obj[k] }));
    const localidades = Array.from(new Set(usuarios.map(u=>u.localidade||'').filter(Boolean)));
    if(localidades.length===0){ showToast('Nenhuma localidade encontrada','error'); return; }
    let options=''; localidades.sort((a,b)=>normalize(a).localeCompare(normalize(b))).forEach(loc=> options += `<option value="${escapeHtml(loc)}">${escapeHtml(loc)}</option>`);
    const html = `
  <label>Localidade:</label>
  <select id="__sel_localidade">${options}</select>
  <div style="text-align:center;margin-top:12px;">
    <button id="__view_local">üëÅÔ∏è Visualizar</button>
    <button id="__print_local">üñ®Ô∏è Imprimir</button>
    <button class="btn-muted" id="__cancel_local">Cancelar</button>
  </div>
`;
abrirModal('Relat√≥rio por Localidade', html);

    $('#__print_local').onclick = async ()=>{
      const loc=$('#__sel_localidade').value; fecharModal();
      const snapP = await db.ref('pedidos').once('value');
      const pedidosObj=snapP.val()||{}; const pedidos=Object.keys(pedidosObj).map(k=>({ key:k, ...pedidosObj[k] }));
      const filtered = pedidos.filter(p=> (p.createdByLocalidade||'')===loc );
      let bodyRows='';
      filtered.forEach((p,i)=>{
        bodyRows += `<tr>
          <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByName||p.createdBy||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.produtoText)}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.quantidade)}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.obs||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${p.entregue? 'Entregue':'Aberto'}</td>
          <td class="check-col" style="border:1px solid #ddd;">[  ]</td>
        </tr>`;
      });
      const htmlDoc = `
        <div class="print-header">
          <div><h3 style="margin:0;">Pedidos - ${escapeHtml(loc)}</h3><div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div></div>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#0056b3; color:#fff;">
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">Usu√°rio</th>
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">Qtd</th>
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">Obs</th>
              <th style="text-align:left;padding:8px;border:1px solid #ddd;">Status</th>
              <th class="check-col" style="border:1px solid #ddd;">Visto ‚úì</th>
            </tr>
          </thead>
          <tbody>${bodyRows||'<tr><td colspan="7">Sem dados</td></tr>'}</tbody>
        </table>
        <div class="signature-grid">
          <div class="signature-box">Respons√°vel / Assinatura</div>
          <div class="signature-box">Conferente / Visto</div>
        </div>`;
      printHtml(htmlDoc, `Pedidos - ${loc}`);
    };
$('#__view_local').onclick = async ()=>{
  const loc = $('#__sel_localidade').value;
  const snapP = await db.ref('pedidos').once('value');
  const pedidosObj = snapP.val() || {};
  const pedidos = Object.keys(pedidosObj).map(k => ({ key:k, ...pedidosObj[k] }));
  const filtered = pedidos.filter(p => (p.createdByLocalidade||'') === loc );

  let bodyRows = '';
  filtered.forEach((p,i) => {
    bodyRows += `<tr>
      <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
      <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByName||p.createdBy||'')}</td>
      <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.produtoText)}</td>
      <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.quantidade)}</td>
      <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.obs||'')}</td>
      <td style="border:1px solid #ddd;padding:6px;">${p.entregue? 'Entregue':'Aberto'}</td>
    </tr>`;
  });

  const htmlDoc = `
    <div class="print-header">
      <div>
        <h3 style="margin:0;">Pedidos - ${escapeHtml(loc)}</h3>
        <div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div>
      </div>
    </div>
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#0056b3; color:#fff;">
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">Usu√°rio</th>
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">Qtd</th>
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">Obs</th>
          <th style="text-align:left;padding:8px;border:1px solid #ddd;">Status</th>
        </tr>
      </thead>
      <tbody>${bodyRows || '<tr><td colspan="6">Sem dados</td></tr>'}</tbody>
    </table>
  `;

  // Abre dentro do modal, sem imprimir
  abrirModal(`Visualiza√ß√£o ‚Äì ${escapeHtml(loc)}`, htmlDoc);
};

    $('#__cancel_local').onclick=()=>fecharModal();
  }catch(e){ showToast('Erro ao preparar impress√£o por localidade','error'); }
}

async function imprimirResumoItensGeral(){
  try{
    const snapP = await db.ref('pedidos').once('value'); const pedidosObj=snapP.val()||{};
    const pedidos = Object.keys(pedidosObj).map(k=>({ key:k, ...pedidosObj[k] }));
    const map={}; // apenas ABERTOS
    pedidos.filter(p=>!p.entregue).forEach(p=>{ const name=p.produtoText||'Sem produto'; map[name]=(map[name]||0)+Number(p.quantidade||0); });
    let bodyRows='';
    Object.keys(map).sort((a,b)=>normalize(a).localeCompare(normalize(b))).forEach((name,i)=>{
      bodyRows += `<tr>
        <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(name)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(map[name])}</td>
        <td class="check-col" style="border:1px solid #ddd;">[  ]</td>
      </tr>`;
    });
    const htmlDoc = `
      <div class="print-header"><div><h3 style="margin:0;">Resumo de Itens - (Somente Abertos)</h3><div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div></div></div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#0056b3; color:#fff;">
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Quantidade Total</th>
            <th class="check-col" style="border:1px solid #ddd;">Visto ‚úì</th>
          </tr>
        </thead>
        <tbody>${bodyRows || '<tr><td colspan="4">Sem dados</td></tr>'}</tbody>
      </table>
      <div class="signature-grid"><div class="signature-box">Respons√°vel / Assinatura</div><div class="signature-box">Conferente / Visto</div></div>`;
    printHtml(htmlDoc, 'Resumo de Itens - Abertos');
  }catch(e){ showToast('Erro ao imprimir resumo de itens','error'); }
}
async function abrirRelatorioCiclosFechados(){
  try{
    // Buscar todos os ciclos dispon√≠veis no banco
    const snap = await db.ref('pedidos').once('value');
    const obj = snap.val() || {};
    const pedidos = Object.values(obj);
    const ciclos = [...new Set(pedidos.map(p => p.cycleId).filter(Boolean))].sort().reverse();

    if(ciclos.length === 0){
      showToast('Nenhum ciclo encontrado ainda.', 'warn');
      return;
    }

    let options = ciclos.map(c => `<option value="${c}">${c}</option>`).join('');
    const html = `
      <label for="selCiclo">Selecione o ciclo:</label>
      <select id="selCiclo">${options}</select>
      <div style="text-align:center;margin-top:12px;">
        <button id="btnViewCiclo">üëÅÔ∏è Visualizar</button>
        <button id="btnPrintCiclo">üñ®Ô∏è Imprimir</button>
        <button id="btnExcelCiclo">‚¨áÔ∏è Exportar Excel</button>
        <button class="btn-muted" id="btnCancelCiclo">Cancelar</button>
      </div>
    `;
    abrirModal('Relat√≥rios de Ciclos Fechados', html);

    $('#btnCancelCiclo').onclick = fecharModal;

    // Fun√ß√£o comum de filtro
    const gerarRelatorio = async (modo='view')=>{
      const ciclo = $('#selCiclo').value;
      const filtered = pedidos.filter(p => p.cycleId === ciclo);
      if(filtered.length === 0){
        showToast('Nenhum pedido encontrado neste ciclo.', 'warn');
        return;
      }

      // Montar HTML do relat√≥rio
      let bodyRows = '';
      filtered.forEach((p,i)=>{
        bodyRows += `<tr>
          <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByName||p.createdBy||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByLocalidade||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.produtoText||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.quantidade||0)}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.obs||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${p.entregue?'Entregue':'Aberto'}</td>
        </tr>`;
      });

      const htmlDoc = `
        <div class="print-header">
          <div>
            <h3 style="margin:0;">Relat√≥rio de Pedidos ‚Äì Ciclo ${escapeHtml(ciclo)}</h3>
            <div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div>
          </div>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#0056b3;color:#fff;">
              <th>#</th><th>Usu√°rio</th><th>Localidade</th><th>Produto</th><th>Qtd</th><th>Obs</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${bodyRows}</tbody>
        </table>
      `;

      if(modo === 'view') abrirModal(`Visualiza√ß√£o ‚Äì Ciclo ${ciclo}`, htmlDoc);
      if(modo === 'print') printHtml(htmlDoc, `Relat√≥rio ${ciclo}`);
      if(modo === 'excel'){
        // Gerar planilha Excel
        const head = ['Usu√°rio','Localidade','Produto','Qtd','Obs','Status'];
        const rows = filtered.map(p => [
          p.createdByName||p.createdBy||'',
          p.createdByLocalidade||'',
          p.produtoText||'',
          p.quantidade||0,
          p.obs||'',
          p.entregue?'Entregue':'Aberto'
        ]);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([head,...rows]);
        XLSX.utils.book_append_sheet(wb, ws, `Ciclo_${ciclo}`);
        XLSX.writeFile(wb, `relatorio_ciclo_${ciclo}.xlsx`);
        showToast('Excel exportado com sucesso!','info');
      }
    };

    $('#btnViewCiclo').onclick = ()=> gerarRelatorio('view');
    $('#btnPrintCiclo').onclick = ()=> gerarRelatorio('print');
    $('#btnExcelCiclo').onclick = ()=> gerarRelatorio('excel');
  }catch(e){
    console.error(e);
    showToast('Erro ao carregar ciclos', 'error');
  }
}

async function previewResumoItensGeral(){
  try{
    const snapP = await db.ref('pedidos').once('value');
    const pedidosObj = snapP.val() || {};
    const pedidos = Object.keys(pedidosObj).map(k => ({ key:k, ...pedidosObj[k] }));
    const map = {};
    pedidos.filter(p => !p.entregue).forEach(p => {
      const name = p.produtoText || 'Sem produto';
      map[name] = (map[name] || 0) + Number(p.quantidade || 0);
    });

    let bodyRows = '';
    Object.keys(map).sort((a,b)=>normalize(a).localeCompare(normalize(b))).forEach((name,i)=>{
      bodyRows += `<tr>
        <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(name)}</td>
        <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(map[name])}</td>
      </tr>`;
    });

    const htmlDoc = `
      <div class="print-header">
        <div><h3 style="margin:0;">Resumo de Itens (Somente Abertos)</h3>
        <div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div></div>
      </div>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#0056b3; color:#fff;">
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">#</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Produto</th>
            <th style="text-align:left;padding:8px;border:1px solid #ddd;">Quantidade Total</th>
          </tr>
        </thead>
        <tbody>${bodyRows || '<tr><td colspan="3">Sem dados</td></tr>'}</tbody>
      </table>
    `;

    abrirModal('Pr√©-visualiza√ß√£o ‚Äì Resumo de Itens', htmlDoc);
  }catch(e){ showToast('Erro ao gerar pr√©-visualiza√ß√£o','error'); }
}


/* ======= FECHAMENTO ‚Äì Exporta√ß√£o Excel ======= */
// ==============================
// RELAT√ìRIO DE CICLOS FECHADOS (com filtro por localidade)
// ==============================
async function abrirRelatorioCiclosFechados(){
  try{
    // Buscar todos os pedidos
    const snap = await db.ref('pedidos').once('value');
    const obj = snap.val() || {};
    const pedidos = Object.values(obj);

    // Obter lista de ciclos e localidades
    const ciclos = [...new Set(pedidos.map(p => p.cycleId).filter(Boolean))].sort().reverse();
    const localidades = [...new Set(pedidos.map(p => p.createdByLocalidade || 'N√£o Informado'))].sort();

    if(ciclos.length === 0){
      showToast('Nenhum ciclo encontrado ainda.', 'warn');
      return;
    }

    // Monta as op√ß√µes de sele√ß√£o
    const cicloOpts = ciclos.map(c => `<option value="${c}">${c}</option>`).join('');
    const localOpts = ['Todas', ...localidades].map(l => `<option value="${l}">${l}</option>`).join('');

    // HTML do modal
    const html = `
      <label for="selCiclo">Selecione o ciclo:</label>
      <select id="selCiclo">${cicloOpts}</select>

      <label for="selLocal" style="margin-top:10px;display:block;">Filtrar por localidade:</label>
      <select id="selLocal">${localOpts}</select>

      <div style="text-align:center;margin-top:12px;">
        <button id="btnViewCiclo">üëÅÔ∏è Visualizar</button>
        <button id="btnPrintCiclo">üñ®Ô∏è Imprimir</button>
        <button id="btnExcelCiclo">‚¨áÔ∏è Exportar Excel</button>
        <button class="btn-muted" id="btnCancelCiclo">Cancelar</button>
      </div>
    `;

    abrirModal('Relat√≥rios de Ciclos Fechados', html);
    $('#btnCancelCiclo').onclick = fecharModal;

    // Fun√ß√£o que gera o relat√≥rio
    const gerarRelatorio = async (modo='view')=>{
      const ciclo = $('#selCiclo').value;
      const local = $('#selLocal').value;

      // Filtra conforme o ciclo e (opcionalmente) a localidade
      let filtered = pedidos.filter(p => p.cycleId === ciclo);
      if(local !== 'Todas') filtered = filtered.filter(p => (p.createdByLocalidade||'N√£o Informado') === local);

      if(filtered.length === 0){
        showToast('Nenhum pedido encontrado nesse filtro.', 'warn');
        return;
      }

      // Monta o corpo da tabela
      let bodyRows = '';
      filtered.forEach((p,i)=>{
        bodyRows += `<tr>
          <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByName||p.createdBy||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByLocalidade||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.produtoText||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.quantidade||0)}</td>
          <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.obs||'')}</td>
          <td style="border:1px solid #ddd;padding:6px;">${p.entregue?'Entregue':'Aberto'}</td>
        </tr>`;
      });

      // Cabe√ßalho do relat√≥rio
      const titulo = local === 'Todas'
        ? `Relat√≥rio de Pedidos ‚Äì Ciclo ${escapeHtml(ciclo)}`
        : `Relat√≥rio de Pedidos ‚Äì Ciclo ${escapeHtml(ciclo)} (${escapeHtml(local)})`;

      const htmlDoc = `
        <div class="print-header">
          <div>
            <h3 style="margin:0;">${titulo}</h3>
            <div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div>
          </div>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#0056b3;color:#fff;">
              <th>#</th><th>Usu√°rio</th><th>Localidade</th><th>Produto</th><th>Qtd</th><th>Obs</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${bodyRows}</tbody>
        </table>
      `;

      // A√ß√µes
      if(modo === 'view') abrirModal(`Visualiza√ß√£o ‚Äì ${titulo}`, htmlDoc);
      if(modo === 'print') printHtml(htmlDoc, `Relat√≥rio ${ciclo}`);
      if(modo === 'excel'){
        // Exportar Excel
        const head = ['Usu√°rio','Localidade','Produto','Qtd','Obs','Status'];
        const rows = filtered.map(p => [
          p.createdByName||p.createdBy||'',
          p.createdByLocalidade||'',
          p.produtoText||'',
          p.quantidade||0,
          p.obs||'',
          p.entregue?'Entregue':'Aberto'
        ]);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([head,...rows]);
        XLSX.utils.book_append_sheet(wb, ws, `Ciclo_${ciclo}`);
        XLSX.writeFile(wb, `relatorio_ciclo_${ciclo}_${local.replace(/\s+/g,'_')}.xlsx`);
        showToast('Excel exportado com sucesso!','info');
      }
    };

    // Liga os bot√µes
    $('#btnViewCiclo').onclick = ()=> gerarRelatorio('view');
    $('#btnPrintCiclo').onclick = ()=> gerarRelatorio('print');
    $('#btnExcelCiclo').onclick = ()=> gerarRelatorio('excel');

  }catch(e){
    console.error(e);
    showToast('Erro ao carregar ciclos','error');
  }
}
async function exportFechamentoExcel(){
  try{
    const snap = await db.ref('pedidos').once('value');
    const obj = snap.val() || {};
    const pedidos = Object.values(obj);

    if(pedidos.length === 0){
      showToast('Nenhum pedido encontrado para exportar.', 'warn');
      return;
    }

    const rows = pedidos.map(p => ({
      Ciclo: p.cycleId || '-',
      Usuario: p.createdByName || p.createdBy || '-',
      Localidade: p.createdByLocalidade || '-',
      Produto: p.produtoText || '-',
      Quantidade: p.quantidade || 0,
      Obs: p.obs || '',
      Status: p.entregue ? 'Entregue' : 'Aberto'
    }));

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Fechamento');
    XLSX.writeFile(wb, `fechamento_geral_${new Date().toISOString().slice(0,10)}.xlsx`);

    showToast('Arquivo Excel exportado com sucesso!', 'info');
  }catch(e){
    console.error(e);
    showToast('Erro ao exportar fechamento.', 'error');
  }
}

  $('#yearFooter').textContent = new Date().getFullYear();
  setInterval(()=> $('#nowClock').textContent = fmtDateTime(Date.now()), 1000);

  // Login
  $('#btnLogin').onclick = login;
  $('#btnWhatsapp').onclick = ()=>{
  const phone = '5531985330656'; // n√∫mero completo com DDI + DDD, sem + nem espa√ßos
  const msg = encodeURIComponent('Ol√°, preciso de ajuda com o sistema de compras coletivas.');
  const url = `https://wa.me/${phone}?text=${msg}`;
  console.log('Abrindo WhatsApp:', url);
  window.open(url, '_blank');
};

  // Primeiro acesso
  $('#btnVoltarPA').onclick = ()=>{ currentUser=null; go('loginScreen'); };
  $('#paOutraLocalidade').onchange = e=> togglePAOutraLocalidade(e.target.checked);
  $('#btnBuscaCepPA').onclick = async ()=>{
    try{
      const cep=$('#paCep').value.trim();
      const data = await buscaCEP(cep);
      $('#paLogradouro').value = data.logradouro||'';
      $('#paBairro').value = data.bairro||'';
      $('#paCidade').value = data.localidade||'';
      $('#paUf').value = data.uf||'';
      togglePAOutraLocalidade(true);
      showToast('Endere√ßo preenchido pelo CEP','info');
    }catch(e){ showToast(e.message||'Erro no CEP','error'); }
  };
  $('#btnConcluirPA').onclick = async ()=>{
    const nome=$('#paNome').value.trim(); const generoSel=$('#paGenero').value||'auto';
    const user=$('#paUser').value.trim(); const pass=$('#paPass').value.trim();
    let localidade = $('#paCidade').value.trim(); const logradouro=$('#paLogradouro').value.trim(); const bairro=$('#paBairro').value.trim(); const uf=$('#paUf').value.trim();
    if(!nome || !user || !pass){ $('#paMsg').style.color='red'; $('#paMsg').textContent='Preencha nome, usu√°rio e senha.'; return; }
    if($('#paOutraLocalidade').checked){
      if(!localidade){ $('#paMsg').style.color='red'; $('#paMsg').textContent='Informe a cidade.'; return; }
    }
    // criar usu√°rio definitivo
    const ok = await register({ nome, user, pass, localidade: localidade || currentUser?.localidade || '', ministerio:'', genero: generoSel });
    if(!ok) return;
    // remover antigo provis√≥rio (se existir)
    if(currentUser && currentUser.uid){
      try{
        // localizar registro pelo user atual (provis√≥rio)
        const snap = await db.ref('usuarios').orderByChild('user').equalTo(currentUser.user).once('value');
        const data=snap.val();
        if(data){ const key=Object.keys(data)[0]; await db.ref('usuarios/'+key).remove(); }
      }catch(e){}
    }
    showToast('Agora voc√™ j√° pode entrar com seu novo usu√°rio.','info');
    go('loginScreen');
  };

  // Pedido
  $('#buscaProduto').addEventListener('input', filtrarProdutos);
  $('#btnSalvarPedido').onclick = salvarPedido;
  $('#btnMeusPedidos').onclick = ()=> mostrarPedidosUsuario($('#filtroUsuario').value||'todos');
  $('#btnLogout').onclick = logout;

  // Admin nav
  $('#adminRelatorioBtn').onclick = ()=> verRelatorioAdmin($('#filtroAdmin').value||'todos');
  $('#adminProdutosBtn').onclick = abrirCadastroProduto;
  $('#adminUsuariosBtn').onclick = abrirCadastroUsuarioAdmin;
  $('#adminHistoricoBtn').onclick = abrirHistoricoAdmin;

  // Relat√≥rio Usu√°rio
  $('#filtroUsuario').onchange = e=> mostrarPedidosUsuario(e.target.value);
  $('#toggleOcultarEntreguesUsuario2').onchange = ()=> mostrarPedidosUsuario($('#filtroUsuario').value||'todos');
  $('#btnImprimirRelUsuario').onclick = imprimirRelatorioUsuario;
  $('#btnPreviewRelUsuario').onclick = previewRelUsuario;
  $('#btnVoltarUsuario').onclick = ()=> go('pedidoScreen');

  // Relat√≥rio Admin
  $('#filtroAdmin').onchange = e=> verRelatorioAdmin(e.target.value);
  $('#toggleOcultarEntreguesAdmin').onchange = ()=> verRelatorioAdmin($('#filtroAdmin').value||'todos');
  $('#btnImprimirRelGeral').onclick = imprimirRelatorioAdmin;
  $('#btnPreviewRelGeral').onclick = previewRelGeral;
  $('#btnImprimirRelLocalidade').onclick = imprimirRelatorioPorLocalidade;
  $('#btnImprimirResumoItens').onclick = imprimirResumoItensGeral;
$('#btnPreviewResumoItens').onclick = previewResumoItensGeral;

  $('#btnExportFechamento').onclick = exportFechamentoExcel;
$('#btnRelatorioCiclos').onclick = abrirRelatorioCiclosFechados;
$('#btnRelatorioStatus').onclick = abrirRelatorioStatus;
$('#btnControleEstoque').onclick = abrirControleEstoqueAdm;
$('#btnRelatorioMovimentacoes').onclick = abrirRelatorioMovimentacoesAdm;
$('#btnExportarExcel').onclick = exportarExcelAdm;




  $('#btnVoltarAdmin').onclick = ()=> go('pedidoScreen');
  $('#btnAbrirCadastroUsuarioAdmin').onclick = abrirCadastroUsuarioAdmin;
  $('#btnAbrirCadastroProduto').onclick = abrirCadastroProduto;

  // Admin Usu√°rios
  $('#btnAdminAddUser').onclick = adminAddUser;
  $('#btnVoltarAdminUsr').onclick = ()=> go('pedidoScreen');

  // Admin Produtos
  $('#btnAddProduto').onclick = addProduto;
  $('#btnVoltarAdminProd').onclick = ()=> go('pedidoScreen');

  // Hist√≥rico
  $('#btnVoltarHistorico').onclick = ()=> go('pedidoScreen');
  $('#filtroHistoricoTipo').onchange = carregarHistoricoAdmin;
  $('#toggleOcultarHistorico').onchange = carregarHistoricoAdmin;

  // Mostrar/ocultar tabelas (Admin)
  const btnUsuarios=$('#btnToggleUsuarios'), tabUsuarios=$('#tabelaUsuariosAdmin');
  if(btnUsuarios && tabUsuarios){
    btnUsuarios.addEventListener('click', ()=>{
      if(tabUsuarios.style.display==='none'){ tabUsuarios.style.display='table'; btnUsuarios.textContent='üë§ Ocultar usu√°rios cadastrados'; }
      else{ tabUsuarios.style.display='none'; btnUsuarios.textContent='üëÅÔ∏è Mostrar usu√°rios cadastrados'; }
    });
  }
  const btnProdutos=$('#btnToggleProdutos'), tabProdutos=$('#tabelaProdutosAdmin');
  if(btnProdutos && tabProdutos){
    btnProdutos.addEventListener('click', ()=>{
      if(tabProdutos.style.display==='none'){ tabProdutos.style.display='table'; btnProdutos.textContent='üì¶ Ocultar produtos cadastrados'; }
      else{ tabProdutos.style.display='none'; btnProdutos.textContent='üëÅÔ∏è Mostrar produtos cadastrados'; }
    });
  }
// ==============================
// RELAT√ìRIO POR STATUS (abertos, entregues, geral)
// ==============================
async function abrirRelatorioStatus() {
  try {
    const snap = await db.ref('pedidos').once('value');
    const pedidosObj = snap.val() || {};
    const pedidos = Object.values(pedidosObj);

    if (pedidos.length === 0) {
      showToast('Nenhum pedido encontrado.', 'warn');
      return;
    }

    const html = `
      <label>Status:</label>
      <select id="selStatus">
        <option value="todos">Todos</option>
        <option value="aberto">Em aberto</option>
        <option value="entregue">Entregues</option>
      </select>
      <div style="text-align:center;margin-top:12px;">
        <button id="btnViewStatus">üëÅÔ∏è Visualizar</button>
        <button id="btnPrintStatus">üñ®Ô∏è Imprimir</button>
        <button id="btnExcelStatus">‚¨áÔ∏è Exportar Excel</button>
        <button class="btn-muted" id="btnCancelStatus">Cancelar</button>
      </div>
    `;
    abrirModal('Relat√≥rios por Status', html);

    $('#btnCancelStatus').onclick = fecharModal;

    const gerarRelatorio = (modo='view') => {
      const status = $('#selStatus').value;
      let filtered = pedidos;
      if (status === 'aberto') filtered = pedidos.filter(p => !p.entregue);
      if (status === 'entregue') filtered = pedidos.filter(p => p.entregue);
// === C√°lculo dos totais ===
const totalGeral = pedidos.length;
const totalEntregues = pedidos.filter(p => p.entregue).length;
const totalAbertos = pedidos.filter(p => !p.entregue).length;

// === Monta o resumo ===
// === Resumo em formato de cards ===
const resumoHtml = `
  <div style="display:flex;justify-content:center;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
    <div style="flex:1;min-width:160px;max-width:220px;background:#d4edda;border:1px solid #28a745;border-radius:10px;padding:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
      <div style="font-size:22px;font-weight:bold;color:#155724;">${totalEntregues}</div>
      <div style="font-size:14px;color:#155724;">Entregues</div>
    </div>
    <div style="flex:1;min-width:160px;max-width:220px;background:#fff3cd;border:1px solid #f0ad4e;border-radius:10px;padding:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
      <div style="font-size:22px;font-weight:bold;color:#856404;">${totalAbertos}</div>
      <div style="font-size:14px;color:#856404;">Em aberto</div>
    </div>
    <div style="flex:1;min-width:160px;max-width:220px;background:#cce5ff;border:1px solid #0056b3;border-radius:10px;padding:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
      <div style="font-size:22px;font-weight:bold;color:#004085;">${totalGeral}</div>
      <div style="font-size:14px;color:#004085;">Total</div>
    </div>
  </div>
`;



      let bodyRows = '';
      filtered.forEach((p,i) => {
        bodyRows += `
          <tr>
            <td style="border:1px solid #ddd;padding:6px;">${i+1}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByName||p.createdBy||'')}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.createdByLocalidade||'')}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.produtoText||'')}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.quantidade||0)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(p.obs||'')}</td>
            <td style="border:1px solid #ddd;padding:6px;">${p.entregue?'Entregue':'Aberto'}</td>
          </tr>`;
      });

      const titulo = status==='todos'
        ? 'Relat√≥rio Geral de Pedidos'
        : `Relat√≥rio de Pedidos (${status==='aberto'?'Em Aberto':'Entregues'})`;

      const htmlDoc = `
 ${resumoHtml}        
<div class="print-header">
          <div><h3 style="margin:0;">${titulo}</h3>
          <div class="print-meta">Gerado em ${fmtDateTime(Date.now())}</div></div>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#0056b3;color:#fff;">
              <th>#</th><th>Usu√°rio</th><th>Localidade</th>
              <th>Produto</th><th>Qtd</th><th>Obs</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${bodyRows || '<tr><td colspan="7">Sem dados</td></tr>'}</tbody>
        </table>
      `;

      if(modo==='view') abrirModal(titulo, htmlDoc);
      if(modo==='print') printHtml(htmlDoc, titulo);
      if(modo==='excel') {
        const head = ['Usu√°rio','Localidade','Produto','Qtd','Obs','Status'];// Adiciona o resumo no topo do Excel
const resumo = [
  ['Resumo:'],
  ['Entregues', totalEntregues],
  ['Em aberto', totalAbertos],
  ['Total geral', totalGeral],
  [],
];

        const rows = filtered.map(p => [
          p.createdByName||p.createdBy||'',
          p.createdByLocalidade||'',
          p.produtoText||'',
          p.quantidade||0,
          p.obs||'',
          p.entregue?'Entregue':'Aberto'
        ]);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([...resumo, head, ...rows]);

        XLSX.utils.book_append_sheet(wb, ws, 'Relat√≥rio_Status');
        XLSX.writeFile(wb, `relatorio_status_${status}_${new Date().toISOString().slice(0,10)}.xlsx`);
        showToast('Excel exportado com sucesso!', 'info');
      }
    };

    $('#btnViewStatus').onclick = ()=> gerarRelatorio('view');
    $('#btnPrintStatus').onclick = ()=> gerarRelatorio('print');
    $('#btnExcelStatus').onclick = ()=> gerarRelatorio('excel');
  } catch (e) {
    console.error(e);
    showToast('Erro ao carregar relat√≥rio por status.', 'error');
  }
}
// ==============================
// MEU ESTOQUE (USU√ÅRIO)
// ==============================
$('#btnMeuEstoque').onclick = async ()=>{
  try{
    const uid = currentUser.uid;
    const snap = await db.ref('estoques/'+uid).once('value');
    const obj = snap.val() || {};

    if(Object.keys(obj).length === 0){
      abrirModal('Meu Estoque', '<p>üì¶ Voc√™ ainda n√£o possui itens em estoque.</p>');
      return;
    }

    let html = `
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:#0056b3;color:#fff;">
            <th>Produto</th><th>Quantidade</th><th>√öltima Entrada</th><th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody>
    `;

    Object.entries(obj).forEach(([pid, p])=>{
      html += `
        <tr>
          <td style="border:1px solid #ddd;padding:6px;">${p.nome}</td>
          <td style="border:1px solid #ddd;padding:6px;">${p.quantidade}</td>
          <td style="border:1px solid #ddd;padding:6px;">${p.ultimaEntrada || '-'}</td>
          <td style="border:1px solid #ddd;padding:6px;text-align:center;">
            <button onclick="darBaixaEstoque('${uid}','${pid}','${p.nome}',${p.quantidade})">‚ûñ Dar baixa</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    abrirModal('üì¶ Meu Estoque', html);

  }catch(e){
    console.error(e);
    showToast('Erro ao carregar estoque','error');
  }
};
// ==============================
// DAR BAIXA NO ESTOQUE (USU√ÅRIO)
// ==============================
async function darBaixaEstoque(uid, pid, nome, qtdAtual){
  const qtd = parseInt(prompt(`Quantas unidades de "${nome}" voc√™ usou? (Em estoque: ${qtdAtual})`));
  if(isNaN(qtd) || qtd <= 0) return;
  if(qtd > qtdAtual){ showToast('Quantidade maior que o estoque atual.','warn'); return; }

  try{
    const ref = db.ref(`estoques/${uid}/${pid}`);
    const snap = await ref.once('value');
    const atual = snap.val()?.quantidade || 0;
    const novaQtd = atual - qtd;

    await ref.update({ quantidade: novaQtd });

    // registra a movimenta√ß√£o de sa√≠da
    const movRef = db.ref(`movimentacoes/${uid}`).push();
    await movRef.set({
      tipo: 'saida',
      produto: nome,
      qtd: qtd,
      data: new Date().toLocaleString('pt-BR'),
      ciclo: 'Atual',
      origem: 'consumo_usuario'
    });

    showToast('Baixa registrada com sucesso!','info');
    $('#btnMeuEstoque').click(); // recarrega a tela
  }catch(e){
    console.error(e);
    showToast('Erro ao registrar baixa.','error');
  }
}

// ==============================
// CONTROLE DE ESTOQUES (ADMIN)
// ==============================
async function abrirControleEstoqueAdm(){
  try {
    const snap = await db.ref('estoques').once('value');
    const estoques = snap.val() || {};

    const todos = [];
    for (const [uid, itens] of Object.entries(estoques)) {
      for (const [pid, p] of Object.entries(itens)) {
        todos.push({
          usuario: uid,
          produto: p.nome,
          quantidade: p.quantidade,
          localidade: p.localidade || 'N√£o Informado',
          pid
        });
      }
    }
const localidades = [...new Set(todos.map(e => e.localidade))].sort();
const locOpts = ['Todas', ...localidades].map(l => `<option value="${l}">${l}</option>`).join('');

    let html = `
      <label>Filtrar por localidade:</label>
      <select id="filtroLocal">${locOpts}</select>
      <table style="width:100%;border-collapse:collapse;margin-top:10px;">
        <thead><tr style="background:#0056b3;color:#fff;">
          <th>Usu√°rio</th><th>Localidade</th><th>Produto</th><th>Qtd</th><th>A√ß√µes</th>
        </tr></thead>
        <tbody id="tbodyEstoqueAdm"></tbody>
      </table>
    `;
    abrirModal('üì¶ Controle de Estoques (Administrador)', html);

    const render = (loc = 'Todas') => {
      const linhas = todos
        .filter(e => loc === 'Todas' || e.localidade === loc)
        .map(e => `
          <tr>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.usuario)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.localidade)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.produto)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${e.quantidade}</td>
            <td style="border:1px solid #ddd;padding:6px;">
              <button onclick="editarEstoqueAdm('${e.usuario}','${e.pid}','${e.produto}',${e.quantidade})">‚úèÔ∏è Editar</button>
            </td>
          </tr>`
        ).join('');

      $('#tbodyEstoqueAdm').innerHTML = linhas || '<tr><td colspan="5">Nenhum registro encontrado.</td></tr>';
    };

    render();
    $('#filtroLocal').onchange = e => render(e.target.value);

  } catch (e) {
    console.error(e);
    showToast('Erro ao carregar estoques', 'error');
  }
}

// ==============================
// EDI√á√ÉO DE ESTOQUE (ADMIN)
// ==============================
async function editarEstoqueAdm(uid, pid, nome, qtdAtual) {
  const novaQtd = parseInt(prompt(`Editar quantidade de "${nome}" (atual: ${qtdAtual})`));
  if (isNaN(novaQtd) || novaQtd < 0) return;

  await db.ref(`estoques/${uid}/${pid}`).update({ quantidade: novaQtd });

  const movRef = db.ref(`movimentacoes/${uid}`).push();
  await movRef.set({
    tipo: 'ajuste',
    produto: nome,
    qtd: novaQtd,
    data: new Date().toLocaleString('pt-BR'),
    ciclo: 'Ajuste manual',
    origem: 'admin_edit'
  });

  showToast('Estoque atualizado com sucesso!', 'info');
  abrirControleEstoqueAdm(); // recarrega a lista
}
// ==============================
// RELAT√ìRIO DE MOVIMENTA√á√ïES (POR CICLO)
// ==============================
async function abrirRelatorioMovimentacoesAdm(){
  try {
    const snap = await db.ref('movimentacoes').once('value');
    const movs = snap.val() || {};
    const todos = [];

    for (const [uid, lista] of Object.entries(movs)) {
      for (const [mid, m] of Object.entries(lista)) {
        todos.push({
          usuario: uid,
          produto: m.produto,
          tipo: m.tipo,
          qtd: m.qtd,
          ciclo: m.ciclo || 'Sem ciclo',
          data: m.data || '-',
          origem: m.origem || '-'
        });
      }
    }

    if (todos.length === 0) {
      abrirModal('üìä Relat√≥rio de Movimenta√ß√µes', '<p>Nenhuma movimenta√ß√£o registrada ainda.</p>');
      return;
    }

    const ciclos = [...new Set(todos.map(e => e.ciclo))].sort();
    const cicloOpts = ['Todos', ...ciclos].map(c => `<option value="${c}">${c}</option>`).join('');

    let html = `
      <label>Filtrar por ciclo:</label>
      <select id="filtroCiclo">${cicloOpts}</select>
      <table style="width:100%;border-collapse:collapse;margin-top:10px;">
        <thead>
          <tr style="background:#0056b3;color:#fff;">
            <th>Usu√°rio</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Ciclo</th><th>Data/Hora</th><th>Origem</th>
          </tr>
        </thead>
        <tbody id="tbodyMovAdm"></tbody>
      </table>
    `;
    abrirModal('üìä Relat√≥rio de Movimenta√ß√µes (por Ciclo)', html);

    const render = (ciclo='Todos')=>{
      const linhas = todos
        .filter(e => ciclo==='Todos' || e.ciclo===ciclo)
        .map(e => `
          <tr>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.usuario)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.produto)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${e.tipo}</td>
            <td style="border:1px solid #ddd;padding:6px;">${e.qtd}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.ciclo)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${escapeHtml(e.data)}</td>
            <td style="border:1px solid #ddd;padding:6px;">${e.origem}</td>
          </tr>`
        ).join('');

      $('#tbodyMovAdm').innerHTML = linhas || '<tr><td colspan="7">Nenhum registro para este ciclo.</td></tr>';
    };

    render();
    $('#filtroCiclo').onchange = e => render(e.target.value);

  } catch(e){
    console.error(e);
    showToast('Erro ao carregar movimenta√ß√µes','error');
  }
}
// ==============================
// EXPORTAR ESTOQUES E MOVIMENTA√á√ïES PARA EXCEL
// ==============================
async function exportarExcelAdm() {
  showToast('Gerando planilha, aguarde...','info');

  try {
    // 1Ô∏è‚É£ Pega dados de estoques
    const snapEst = await db.ref('estoques').once('value');
    const estoques = snapEst.val() || {};
    const dadosEstoque = [];

    for (const [uid, itens] of Object.entries(estoques)) {
      for (const [pid, p] of Object.entries(itens)) {
        dadosEstoque.push({
          Tipo: 'Estoque Atual',
          Usuario: uid,
          Produto: p.nome,
          Quantidade: p.quantidade,
          Localidade: p.localidade || '-',
          Ciclo: p.ciclo || '-',
          Data: p.ultimaEntrada || '-',
          Origem: 'estoque_atual'
        });
      }
    }

    // 2Ô∏è‚É£ Pega dados de movimenta√ß√µes
    const snapMov = await db.ref('movimentacoes').once('value');
    const movs = snapMov.val() || {};
    const dadosMov = [];

    for (const [uid, lista] of Object.entries(movs)) {
      for (const [mid, m] of Object.entries(lista)) {
        dadosMov.push({
          Tipo: m.tipo,
          Usuario: uid,
          Produto: m.produto,
          Quantidade: m.qtd,
          Localidade: '-',
          Ciclo: m.ciclo || '-',
          Data: m.data || '-',
          Origem: m.origem || '-'
        });
      }
    }

    // 3Ô∏è‚É£ Junta tudo
    const todos = [...dadosEstoque, ...dadosMov];

    // 4Ô∏è‚É£ Gera a planilha
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(todos);
    XLSX.utils.book_append_sheet(wb, ws, "Relatorio");

    // 5Ô∏è‚É£ Salva o arquivo
    XLSX.writeFile(wb, `Relatorio_Estoques_Movimentacoes_${new Date().toISOString().slice(0,10)}.xlsx`);
    showToast('Planilha gerada com sucesso!','ok');
  } catch (e) {
    console.error(e);
    showToast('Erro ao exportar planilha','error');
  }
}

// ==============================
// GERENCIAMENTO DE CICLOS AUTOM√ÅTICOS
// ==============================
async function verificarCicloAutomatico(){
  const cfgRef = db.ref('config');
  const snap = await cfgRef.once('value');
  const cfg = snap.val() || {};

  // Configura√ß√µes padr√£o
  const inicio = cfg.cycleStart || Date.now();
  const dias = cfg.cycleDays || 30;
  const bloqueio = cfg.lockBeforeEnd || 5;
  const agora = Date.now();
  const msDia = 1000*60*60*24;

  const passou = (agora - inicio) / msDia;
  const falta = dias - passou;

  // Bloqueio autom√°tico antes do fim
  if(falta <= bloqueio && falta > 0){
    window.__pedidosBloqueados = true;
    console.warn(`üö´ Pedidos bloqueados ‚Äî faltam ${Math.ceil(falta)} dias para o fim do ciclo.`);
  } else {
    window.__pedidosBloqueados = false;
  }

  // Rein√≠cio autom√°tico se o ciclo completou
  if(passou >= dias){
    await cfgRef.update({
      lastCycleEnd: inicio,
      cycleStart: agora
    });
    showToast('üîÅ Novo ciclo iniciado automaticamente!', 'info');
  }

  // Retorna informa√ß√µes √∫teis
  return { passou, falta, dias, bloqueio };
}

// ==============================
// BLOQUEIO DE PEDIDOS (USU√ÅRIO)
// ==============================
async function checarBloqueioPedidos(){
  const info = await verificarCicloAutomatico();
  if(window.__pedidosBloqueados){
    showToast(`üö´ Novos pedidos bloqueados ‚Äî este ciclo se encerra em ${Math.ceil(info.falta)} dias.`, 'warn');
    return true;
  }
  return false;
}

// ==============================
// BOT√ÉO ADMIN: ENCERRAR CICLO MANUALMENTE
// ==============================
$('#btnEncerrarCiclo')?.addEventListener('click', async ()=>{
  const ok = confirm('Deseja encerrar o ciclo atual e iniciar um novo agora?');
  if(!ok) return;
  const agora = Date.now();
  await db.ref('config').update({
    lastCycleEnd: agora,
    cycleStart: agora
  });
  showToast('‚úÖ Ciclo encerrado manualmente e novo ciclo iniciado!', 'info');
  await verificarCicloAutomatico();
});

// ==============================
// EXIBIR STATUS DO CICLO (PAINEL)
// ==============================
async function atualizarStatusCiclo(){
  const info = await verificarCicloAutomatico();
  const el = document.querySelector('#infoCiclo');
  if(!el) return;
  el.innerHTML = `
    <b>üìÖ Ciclo atual:</b> ${info.dias} dias<br>
    <b>‚è≥ Faltam:</b> ${Math.ceil(info.falta)} dias<br>
    <b>üîí Bloqueio:</b> ${info.bloqueio} dias antes do fim
  `;
}
// üîî Avisos di√°rios nos √∫ltimos N dias (ex: 5) ‚Äì uma vez por dia por ciclo
async function checarAvisosUltimosDias(janelaDias = 5){
  try{
    const info = await getCycleInfo(); // j√° existe no seu c√≥digo
    if(!info.open) return;                            // ciclo fechado? nada a fazer
    if(info.daysRemaining <= 0) return;               // j√° acabou
    if(info.daysRemaining > janelaDias) return;       // ainda est√° longe do fim

    // evita repetir no mesmo ciclo e no mesmo dia restante
    const key = `toast_cycle_${info.cycleId}_d${info.daysRemaining}`;
    if(localStorage.getItem(key) === 'shown') return;

    const msg = (info.daysRemaining === 1)
      ? '‚ö†Ô∏è √öltimo dia do ciclo! Novos pedidos est√£o bloqueados nos √∫ltimos dias.'
      : `‚ö†Ô∏è Faltam ${info.daysRemaining} dias para o encerramento do ciclo. Novos pedidos ser√£o bloqueados nos √∫ltimos dias!`;

    showToast(msg, 'warn', 8000);
    localStorage.setItem(key, 'shown');
  }catch(e){
    console.error('Erro ao verificar avisos dos √∫ltimos dias:', e);
  }
}


// Atualiza o status do ciclo a cada 60 segundos
setInterval(atualizarStatusCiclo, 60000);
setInterval(() => checarAvisosUltimosDias(5), 60000);

/* ======= INIT ======= */
(async function init(){
  try{
    const sess = sessionStorage.getItem('ccb_user');
    if(sess){ currentUser = JSON.parse(sess); enterApp(); }
    const cfg = await db.ref('config/cycleStart').once('value');
    if(!cfg.exists() || !cfg.val()) await db.ref('config').set({ cycleStart: Date.now() });
  }catch(e){}

  await loadProdutos();
  await updateCycleInfoUI();
  await checarAvisosUltimosDias(5); // ‚ö†Ô∏è roda o aviso logo que o sistema carrega

  // refresh leve ao focar
  let __focusRefreshTimer=null;
  window.addEventListener('focus', ()=>{
    clearTimeout(__focusRefreshTimer);
    __focusRefreshTimer = setTimeout(async ()=>{
      try{
        await loadProdutos(); await renderAdminUsuarios(); await updateCycleInfoUI();
        if(lastScreen==='historicoAdmin') await carregarHistoricoAdmin();
        if(lastScreen==='relatorioAdmin') await verRelatorioAdmin($('#filtroAdmin').value||'todos');
      }catch(e){}
    }, 150);
  });
})();

</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<style id="ccb-modern-theme">
  :root{
    --ccb-blue:#0056b3;
    --ccb-blue-600:#0b63c7;
    --ccb-bg:#f6f8fb;
    --ccb-card:#ffffff;
    --ccb-text:#1f2937;
    --ccb-muted:#6b7280;
    --ccb-border:#e5e7eb;
    --radius:14px;
    --shadow:0 8px 22px rgba(2,8,20,.06);
  }
  html,body{background:var(--ccb-bg); color:var(--ccb-text);}
  .card{background:var(--ccb-card)!important; border:1px solid var(--ccb-border)!important; border-radius:var(--radius)!important; box-shadow:var(--shadow)!important;}
  .print-header h2, .print-header h3 { color: var(--ccb-blue); }
  /* Elegant uniform button system */
  button, .btn, .chipbar button{
    appearance:none; border:0; background:var(--ccb-blue);
    color:#fff!important; padding:10px 14px; line-height:1;
    border-radius:10px; cursor:pointer; font-weight:600;
    box-shadow:0 2px 0 rgba(0,0,0,.08), 0 6px 16px rgba(0,86,179,.15);
    transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;
    white-space:nowrap;
  }
  button:hover{ filter:brightness(1.05); box-shadow:0 3px 0 rgba(0,0,0,.10), 0 10px 24px rgba(0,86,179,.22);}
  button:active{ transform:translateY(1px);}
  /* Muted / danger variants if the original uses classes */
  .btn-muted{ background:#eef2f7!important; color:#223!important; border:1px solid var(--ccb-border)!important; box-shadow:none!important; }
  .btn-warn{ background:#0b63c7!important; }
  .btn-danger{ background:#e11d48!important; }
  /* Inline toolbar layout improvements */
  .chipbar.right, .chipbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .chipbar input[type="text"], .chipbar input[type="search"], .chipbar input[placeholder]{
    border:1px solid var(--ccb-border); border-radius:10px; padding:9px 12px; outline:none;
    background:#fff; min-width:210px;
  }
  /* Modal base (in case original styles miss something) */
  .modal-overlay{
    position:fixed; inset:0; background:rgba(15,23,42,.48);
    display:none; align-items:center; justify-content:center; z-index:9999; padding:24px;
  }
  .modal-overlay.open{ display:flex; }
  .modal{
    background:#fff; border-radius:16px; width:min(720px, 96vw); border:1px solid var(--ccb-border);
    box-shadow:var(--shadow);
  }
  .modal header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--ccb-border); }
  .modal header h3{ margin:0; font-size:18px; color:var(--ccb-blue); }
  .modal .content{ padding:16px 18px; }
  .modal .actions{ display:flex; gap:12px; justify-content:flex-end; padding:16px 18px; border-top:1px solid var(--ccb-border); }
</style>

<script id="ccb-enhance-ui">
document.addEventListener('DOMContentLoaded', function(){
  try{
    // 1) Uniformizar bot√µes antigos (classes variadas) ‚Äì nada destrutivo
    document.querySelectorAll('button').forEach(btn=>{
      // preserva classes, apenas garante padroniza√ß√£o visual
      if(!btn.classList.contains('btn') && !btn.classList.contains('btn-muted') && !btn.classList.contains('btn-danger')){
        btn.classList.add('btn');
      }
    });

    // 2) Garantir que o Modal existe; se n√£o, aborta com aviso
    let modalRel = document.querySelector('#modalRelatoriosGerais');
    const hadModal = !!modalRel;
    if(!modalRel){
      // Se modal n√£o existe no HTML original, criaremos um rapidamente
      const temp = document.createElement('div');
      temp.innerHTML = `
<!-- Modal Relat√≥rios Gerais (injetado) -->
<div id="modalRelatoriosGerais" class="modal-overlay hidden" style="display:none;">
  <div class="modal">
    <header>
      <h3>Relat√≥rios Gerais</h3>
      <button id="btnFecharModalRel" class="btn-muted">Fechar</button>
    </header>
    <div class="content">
      <p>Escolha a a√ß√£o para o relat√≥rio geral do administrador.</p>
    </div>
    <div class="actions">
      <button id="btnVisualizarGeralModal">üëÅÔ∏è Visualizar</button>
      <button id="btnImprimirGeralModal">üñ®Ô∏è Imprimir</button>
    </div>
  </div>
</div>
`.trim();
      modalRel = temp.firstElementChild;
      document.body.appendChild(modalRel);
    }

    const btnFecharRel = document.querySelector('#btnFecharModalRel');
    const btnVisualizarModal = document.querySelector('#btnVisualizarGeralModal');
    const btnImprimirModal = document.querySelector('#btnImprimirGeralModal');

    // 3) Local da barra de a√ß√µes em Relat√≥rio Admin
    const ref = document.querySelector('#btnImprimirRelLocalidade');

    // 4) Criar bot√£o principal "Relat√≥rios Gerais"
    const novoBotao = document.createElement('button');
    novoBotao.id = 'btnRelatoriosGeraisModal';
    novoBotao.className = 'btn-warn';
    novoBotao.textContent = 'üìä Relat√≥rios Gerais';

    if(ref && ref.parentElement){
      // insere antes do "Por Localidade"
      ref.insertAdjacentElement('beforebegin', novoBotao);
    }else{
      // fallback: tenta inserir no topo do bloco de relat√≥rios
      const barra = document.querySelector('#relatorioAdmin .chipbar, #relatorioAdmin .print-header, #relatorioAdmin');
      if(barra){
        barra.insertAdjacentElement('afterbegin', novoBotao);
      }else{
        // caso extremo, joga no topo do body
        document.body.prepend(novoBotao);
      }
    }

    // 5) Oculta os bot√µes "Visualizar" e "Imprimir Geral" de fora
    const btnPreviewOut = document.querySelector('#btnPreviewRelGeral');
    const btnImprimirOut = document.querySelector('#btnImprimirRelGeral');
    if(btnPreviewOut) btnPreviewOut.style.display = 'none';
    if(btnImprimirOut) btnImprimirOut.style.display = 'none';

    // 6) A√ß√µes do bot√£o principal -> abre modal
    function abrirModalRel(){
      if(!modalRel) return;
      modalRel.style.display = 'flex';
      modalRel.classList.remove('hidden');
      modalRel.classList.add('open');
    }
    novoBotao.addEventListener('click', abrirModalRel);

    // 7) Fecha modal
    if(btnFecharRel){
      btnFecharRel.addEventListener('click', ()=>{
        modalRel.style.display = 'none';
        modalRel.classList.add('hidden');
        modalRel.classList.remove('open');
      });
    }else{
      // Se o bot√£o n√£o existir (caso modal original tenha outro bot√£o), fecha clicando fora
      modalRel.addEventListener('click', (e)=>{
        if(e.target === modalRel){
          modalRel.style.display = 'none';
          modalRel.classList.add('hidden');
          modalRel.classList.remove('open');
        }
      });
    }

    // 8) Bot√µes internos do modal chamam as fun√ß√µes ORIGINAIS
    if(btnVisualizarModal){
      btnVisualizarModal.addEventListener('click', ()=>{
        if(typeof previewRelGeral === 'function'){
          previewRelGeral();
        }else{
          alert('Fun√ß√£o previewRelGeral() n√£o encontrada.');
        }
        modalRel.style.display = 'none';
        modalRel.classList.add('hidden');
        modalRel.classList.remove('open');
      });
    }
    if(btnImprimirModal){
      btnImprimirModal.addEventListener('click', ()=>{
        if(typeof imprimirRelatorioAdmin === 'function'){
          imprimirRelatorioAdmin();
        }else{
          alert('Fun√ß√£o imprimirRelatorioAdmin() n√£o encontrada.');
        }
        modalRel.style.display = 'none';
        modalRel.classList.add('hidden');
        modalRel.classList.remove('open');
      });
    }

    // 9) Seguran√ßa extra: se as fun√ß√µes originais n√£o existirem no momento do DOMContentLoaded
    // tentamos anexar handlers quando a janela terminar de carregar (caso scripts demorem)
    window.addEventListener('load', ()=>{
      if(btnVisualizarModal && typeof previewRelGeral !== 'function'){
        const tryAgain = setInterval(()=>{
          if(typeof previewRelGeral === 'function'){
            clearInterval(tryAgain);
          }
        }, 300);
        setTimeout(()=> clearInterval(tryAgain), 6000);
      }
    });

  }catch(err){
    console.error('Erro no aprimoramento de UI CCB:', err);
  }
});
</script>
<script src="patch_admin_localidades.js"></script>
</body>
</html>






